# 功能更新说明

## 更新日期
2024年12月17日

## 更新内容

### 1. 订单与用户绑定 ✅
- **实现方式**: 订单表中的 `user_id` 字段绑定发布者的唯一ID
- **数据库字段**: 
  - `user_id`: 订单发布者ID（外键关联users表）
  - `acceptor_id`: 订单接单者ID（外键关联users表）
- **功能说明**: 每个用户发布的订单都会自动绑定该用户的ID，便于追踪和管理

### 2. 订单大厅显示规则 ✅
- **显示规则**: 订单大厅默认只显示未完成的订单
  - 显示状态: `pending`（待接单）和 `accepted`（已接单）
  - 不显示: `completed`（已完成）和 `cancelled`（已取消）
- **实现位置**: `errand-back/src/controllers/order.controller.js` - `getOrders` 方法
- **API接口**: `GET /orders`
  - 默认参数: `status=pending,accepted`
  - 可自定义状态筛选

### 3. 已完成订单记录保留 ✅
- **保留方式**: 订单完成后不删除，只更新状态为 `completed`
- **查看方式**: 
  - 我发布的订单: `GET /orders/my-publish`
  - 我接受的订单: `GET /orders/my-accepted`
- **数据库字段**:
  - `completed_at`: 完成时间
  - `cancelled_at`: 取消时间
  - `status`: 订单状态

### 4. 账号密码登录 ✅
- **登录方式**: 支持用户名或邮箱 + 密码登录
- **API接口**: `POST /auth/login`
- **请求参数**:
  ```json
  {
    "username": "user123",  // 用户名（优先）
    "email": "user@example.com",  // 或邮箱
    "password": "password123"
  }
  ```
- **实现位置**: 
  - 后端: `errand-back/src/controllers/auth.controller.js` - `login` 方法
  - 前端: `errand-front/pages/login/login.js`

### 5. 简化注册流程 ✅
- **注册要求**: 只需提供用户名、密码、确认密码
- **API接口**: `POST /auth/register`
- **请求参数**:
  ```json
  {
    "username": "user123",
    "password": "password123",
    "confirmPassword": "password123",
    "email": "user@example.com"  // 可选
  }
  ```
- **验证规则**:
  - 用户名必须唯一
  - 密码长度至少6位
  - 两次密码必须一致
  - 邮箱为可选字段
- **实现位置**: 
  - 后端: `errand-back/src/controllers/auth.controller.js` - `register` 方法
  - 前端: `errand-front/pages/login/login.js`

## 前端更新

### 登录页面 (errand-front/pages/login/)
- **新增功能**:
  - 用户名密码登录表单
  - 注册表单
  - 登录/注册模式切换
  - 保留测试账号快速登录
- **UI改进**:
  - 添加输入框样式
  - 添加模式切换按钮
  - 优化布局和交互

### 用户模型 (errand-back/src/models/User.js)
- **新增方法**:
  - `findByUsername()`: 通过用户名查找用户
  - 支持用户名登录验证

## 数据库结构

### 订单表 (orders)
```sql
CREATE TABLE orders (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL COMMENT '发布者ID',
  acceptor_id INT NULL COMMENT '接单者ID',
  title VARCHAR(200) NOT NULL,
  description TEXT NOT NULL,
  type INT NOT NULL,
  price DECIMAL(10,2) NOT NULL,
  status ENUM('pending', 'accepted', 'completed', 'cancelled') DEFAULT 'pending',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  accepted_at TIMESTAMP NULL,
  completed_at TIMESTAMP NULL,
  cancelled_at TIMESTAMP NULL,
  FOREIGN KEY (user_id) REFERENCES users(id),
  FOREIGN KEY (acceptor_id) REFERENCES users(id)
);
```

### 用户表 (users)
```sql
CREATE TABLE users (
  id INT PRIMARY KEY AUTO_INCREMENT,
  username VARCHAR(50) UNIQUE,
  email VARCHAR(100) UNIQUE,
  password VARCHAR(255),
  nickname VARCHAR(100),
  openid VARCHAR(100) UNIQUE,
  role ENUM('student', 'teacher', 'admin') DEFAULT 'student',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## API文档更新

详细的API文档已更新，请查看 `errand-back/API-DOCUMENTATION.md`

主要更新的接口：
- `POST /auth/login` - 支持多种登录方式
- `POST /auth/register` - 新增注册接口
- `GET /orders` - 订单大厅接口，默认只显示未完成订单

## 测试建议

### 1. 注册测试
```bash
# 测试注册
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "123456",
    "confirmPassword": "123456"
  }'
```

### 2. 登录测试
```bash
# 用户名登录
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "123456"
  }'
```

### 3. 订单大厅测试
```bash
# 获取订单大厅（只显示未完成订单）
curl -X GET "http://localhost:3000/api/orders?page=1&pageSize=10" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 获取所有状态的订单
curl -X GET "http://localhost:3000/api/orders?status=pending,accepted,completed,cancelled" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 兼容性说明

- 保持向后兼容，原有的微信登录功能仍然可用
- 原有的邮箱密码登录功能仍然可用
- 新增的用户名登录不影响现有功能

## 注意事项

1. **密码安全**: 密码使用bcrypt加密存储，加密强度为12
2. **Token有效期**: JWT Token默认有效期为7天
3. **用户名唯一性**: 注册时会检查用户名是否已存在
4. **订单状态**: 订单状态流转为 pending → accepted → completed
5. **数据保留**: 已完成和已取消的订单会永久保留在数据库中

## 后续优化建议

1. 添加密码强度验证（大小写、数字、特殊字符）
2. 添加找回密码功能
3. 添加手机号注册和登录
4. 添加图形验证码防止恶意注册
5. 添加订单归档功能（定期归档旧订单）
6. 添加用户名格式验证（长度、字符限制）
