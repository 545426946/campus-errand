# 未登录用户体验优化

## 问题描述
用户未登录时访问页面会直接跳转到登录页面，无法自由浏览。

## 根本原因
`api/request.js` 中的响应拦截器在接收到 401 状态码时会自动执行 `wx.navigateTo({ url: '/pages/login/login' })`，导致所有未登录用户在调用 API 时都被强制跳转。

## 优化目标
允许未登录用户浏览小程序内容，只在需要登录的操作时友好提示，不强制跳转到登录页面。

---

## 修复方案

### 1. 核心修复：移除 API 拦截器中的自动跳转 ⭐
**文件：** `errand-front/api/request.js`

**修改前：**
```javascript
} else if (statusCode === 401) {
  // 未授权，跳转登录
  toast.error('请先登录')
  wx.removeStorageSync('token')
  wx.removeStorageSync('userInfo')
  const app = getApp()
  app.globalData.isLogin = false
  app.globalData.userInfo = null
  wx.navigateTo({
    url: '/pages/login/login'  // ❌ 自动跳转
  })
  return Promise.reject(new Error('未授权'))
}
```

**修改后：**
```javascript
} else if (statusCode === 401) {
  // 未授权，清除登录信息但不自动跳转
  // 让各个页面自己决定是否需要跳转到登录页
  wx.removeStorageSync('token')
  wx.removeStorageSync('userInfo')
  const app = getApp()
  app.globalData.isLogin = false
  app.globalData.userInfo = null
  
  // ✅ 不再自动跳转，只返回错误
  // 各个页面可以根据需要自行处理
  return Promise.reject(new Error('未授权'))
}
```

### 2. 页面级别的登录检查优化

#### 首页 (index.js) ✅
- 已支持未登录浏览
- 未登录用户可以查看所有订单列表
- 可以搜索和筛选订单
- 点击"接单"或"发布订单"时会提示登录

#### 订单页面 (order.js) ✅
**修改前：**
- 进入页面时强制检查登录，未登录直接跳转到登录页

**修改后：**
- 移除 `onLoad` 中的强制登录检查
- 允许未登录用户查看"待接单"、"进行中"、"已完成"标签页的公开订单
- 切换到"我发布的"或"我接受的"标签页时提示登录
- 执行"接单"、"取消订单"、"完成订单"等操作时提示登录

#### 订单详情页 (detail.js) ✅
**修改前：**
- 进入页面时强制检查登录，未登录直接跳转到登录页

**修改后：**
- 移除 `onLoad` 中的强制登录检查
- 允许未登录用户查看订单详情
- 未登录用户可以查看订单的所有信息（标题、描述、价格、位置等）
- 执行以下操作时会提示登录：
  - 接单
  - 取消订单
  - 完成订单
  - 拨打电话
  - 联系发布者
  - 联系接单者

#### 用户中心页 (user.js) ✅
- 已支持未登录浏览
- 未登录时显示"点击登录"提示
- 点击需要登录的功能时会提示登录

---

## 优化效果

### 未登录用户现在可以：
✅ 浏览首页的所有订单列表  
✅ 搜索和筛选订单  
✅ 查看订单详情（标题、描述、价格、位置等）  
✅ 浏览"待接单"、"进行中"、"已完成"的公开订单  
✅ 查看用户中心页面  

### 未登录用户不可以（会提示登录）：
❌ 发布订单  
❌ 接单  
❌ 取消订单  
❌ 完成订单  
❌ 查看联系方式  
❌ 查看"我发布的"和"我接受的"订单  

---

## 交互流程

### 场景1: 未登录用户浏览
```
1. 打开小程序 → 直接进入首页
2. 浏览订单列表 → 正常显示
3. 点击订单 → 查看详情
4. 搜索订单 → 正常搜索
5. 筛选服务类型 → 正常筛选
```

### 场景2: 未登录用户尝试操作
```
1. 点击"接单"按钮
   ↓
2. 弹窗提示"需要登录"
   ↓
3. 用户选择：
   - 点击"去登录" → 跳转登录页
   - 点击"取消" → 继续浏览
```

## 登录提示方式
所有需要登录的操作都会弹出友好的提示框：

```javascript
wx.showModal({
  title: '需要登录',
  content: 'XXX功能需要登录后使用，是否前往登录？',
  confirmText: '去登录',
  cancelText: '取消',
  success: (res) => {
    if (res.confirm) {
      wx.navigateTo({
        url: '/pages/login/login'
      });
    }
  }
});
```

用户可以选择：
- **去登录**：跳转到登录页面
- **取消**：继续浏览当前页面

---

## 技术实现

1. 移除了 API 拦截器中的自动跳转逻辑
2. 移除了页面加载时的强制登录检查
3. 在每个需要登录的操作函数中添加登录检查
4. 使用 `authUtil.isLoggedIn()` 检查登录状态
5. 使用 `authUtil.requireLogin()` 显示登录提示
6. 保持了良好的用户体验，不会打断用户的浏览流程

---

## 测试建议

1. ✅ 清除小程序缓存，确保未登录状态
2. ✅ 浏览首页、订单页、订单详情页，验证可以正常查看
3. ✅ 尝试执行各种操作，验证登录提示是否正确显示
4. ✅ 登录后验证所有功能是否正常工作
5. ✅ 退出登录后验证是否可以继续浏览

---

## 总结
通过移除 API 拦截器中的自动跳转逻辑，并在各个页面的操作函数中添加登录检查，实现了"浏览自由，操作需登录"的用户体验。这样既保护了需要登录的功能，又不会打断未登录用户的浏览流程。
