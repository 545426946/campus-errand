# 用户注册登录流程说明

## 概述

本系统实现了完整的用户注册和登录功能，用户信息保存在 MySQL 数据库中，使用 JWT 进行身份认证。

---

## 技术实现

### 后端技术
- **数据库**: MySQL - 存储用户信息
- **密码加密**: bcryptjs - 使用 bcrypt 算法加密密码
- **身份认证**: JWT (JSON Web Token) - 生成和验证用户令牌
- **密码强度**: 12 轮加密，安全性高

### 前端技术
- **存储**: 微信小程序本地存储 (wx.setStorageSync)
- **状态管理**: 全局 App 对象 + 本地存储
- **认证工具**: utils/auth.js - 统一的认证管理

---

## 数据库表结构

### users 表
```sql
CREATE TABLE users (
  id INT PRIMARY KEY AUTO_INCREMENT,
  username VARCHAR(50) UNIQUE NOT NULL COMMENT '用户名',
  email VARCHAR(100) UNIQUE COMMENT '邮箱',
  password VARCHAR(255) NOT NULL COMMENT '密码（加密）',
  role ENUM('admin', 'teacher', 'student') DEFAULT 'student' COMMENT '角色',
  nickname VARCHAR(100) COMMENT '昵称',
  avatar VARCHAR(255) COMMENT '头像',
  phone VARCHAR(20) COMMENT '手机号',
  openid VARCHAR(100) UNIQUE COMMENT '微信openid',
  balance DECIMAL(10,2) DEFAULT 0.00 COMMENT '账户余额',
  certification_status ENUM('unverified', 'pending', 'verified', 'rejected') DEFAULT 'unverified' COMMENT '认证状态',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

---

## 注册流程

### 1. 前端注册流程

#### 用户操作
1. 用户在登录页面点击"注册"切换到注册模式
2. 输入用户名、密码、确认密码
3. 点击"注册"按钮

#### 前端验证
```javascript
// 1. 验证必填字段
if (!username || !password) {
  return '请输入用户名和密码';
}

// 2. 验证密码一致性
if (password !== confirmPassword) {
  return '两次输入的密码不一致';
}

// 3. 验证密码长度
if (password.length < 6) {
  return '密码长度不能少于6位';
}
```

#### API 调用
```javascript
// 调用注册 API
const result = await userAPI.register(username, password, confirmPassword);

// 保存登录信息
authUtil.saveLoginInfo(result.token, result.user);

// 跳转到首页
wx.switchTab({ url: '/pages/index/index' });
```

### 2. 后端注册流程

#### API 端点
```
POST /api/auth/register
```

#### 请求参数
```json
{
  "username": "testuser",
  "password": "123456",
  "confirmPassword": "123456"
}
```

#### 后端处理流程
```javascript
// 1. 验证必填字段
if (!username || !password) {
  return 400 '用户名和密码不能为空';
}

// 2. 验证密码确认
if (password !== confirmPassword) {
  return 400 '两次输入的密码不一致';
}

// 3. 检查用户名是否已存在
const existingUser = await User.findByUsername(username);
if (existingUser) {
  return 400 '用户名已存在';
}

// 4. 加密密码（12轮bcrypt）
const hashedPassword = await bcrypt.hash(password, 12);

// 5. 保存到数据库
const user = await User.create({
  username,
  password: hashedPassword,
  role: 'student'
});

// 6. 生成 JWT Token
const token = jwt.sign({ id: user.id }, JWT_SECRET, {
  expiresIn: '7d'
});

// 7. 返回结果
return {
  success: true,
  token,
  user: {
    id: user.id,
    username: user.username,
    role: user.role
  }
};
```

#### 响应示例
```json
{
  "success": true,
  "code": 0,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 10,
    "username": "testuser",
    "email": null,
    "role": "student"
  },
  "message": "注册成功"
}
```

---

## 登录流程

### 1. 前端登录流程

#### 用户操作
1. 用户在登录页面输入用户名和密码
2. 点击"登录"按钮

#### 前端验证
```javascript
// 验证必填字段
if (!username || !password) {
  return '请输入用户名和密码';
}
```

#### API 调用
```javascript
// 调用登录 API
const result = await userAPI.accountLogin(username, password);

// 保存登录信息
authUtil.saveLoginInfo(result.token, result.user);

// 跳转到首页
wx.switchTab({ url: '/pages/index/index' });
```

### 2. 后端登录流程

#### API 端点
```
POST /api/auth/login
```

#### 请求参数
```json
{
  "username": "testuser",
  "password": "123456"
}
```

或使用邮箱登录：
```json
{
  "email": "testuser@example.com",
  "password": "123456"
}
```

#### 后端处理流程
```javascript
// 1. 验证必填字段
if (!password) {
  return 400 '请提供密码';
}

if (!username && !email) {
  return 400 '请提供用户名或邮箱';
}

// 2. 查找用户
let user;
if (username) {
  user = await User.findByUsername(username);
} else if (email) {
  user = await User.findByEmail(email);
}

// 3. 验证用户存在
if (!user) {
  return 401 '用户名/邮箱或密码错误';
}

// 4. 验证密码
const isPasswordValid = await bcrypt.compare(password, user.password);
if (!isPasswordValid) {
  return 401 '用户名/邮箱或密码错误';
}

// 5. 生成 JWT Token
const token = jwt.sign({ id: user.id }, JWT_SECRET, {
  expiresIn: '7d'
});

// 6. 返回结果
return {
  success: true,
  token,
  user: {
    id: user.id,
    username: user.username,
    email: user.email,
    role: user.role,
    nickname: user.nickname,
    avatar: user.avatar
  }
};
```

#### 响应示例
```json
{
  "success": true,
  "code": 0,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 10,
    "username": "testuser",
    "email": null,
    "role": "student",
    "nickname": null,
    "avatar": null
  },
  "message": "登录成功"
}
```

---

## 身份认证流程

### 1. Token 存储

#### 前端存储
```javascript
// 保存 Token 和用户信息
wx.setStorageSync('token', token);
wx.setStorageSync('userInfo', userInfo);

// 更新全局状态
const app = getApp();
app.globalData.isLogin = true;
app.globalData.userInfo = userInfo;
```

### 2. Token 使用

#### 前端请求拦截器
```javascript
// 在每个请求中自动添加 Token
const token = wx.getStorageSync('token');
if (token) {
  config.header['Authorization'] = `Bearer ${token}`;
}
```

#### 后端认证中间件
```javascript
// 验证 Token
const token = req.headers.authorization?.replace('Bearer ', '');
if (!token) {
  return 401 '未授权';
}

// 解析 Token
const decoded = jwt.verify(token, JWT_SECRET);

// 查找用户
const user = await User.findById(decoded.id);
if (!user) {
  return 401 '用户不存在';
}

// 将用户信息添加到请求对象
req.user = user;
```

### 3. 受保护的路由

#### 需要登录的接口
```javascript
// 使用 protect 中间件保护路由
router.get('/me', protect, getMe);
router.post('/orders', protect, createOrder);
router.put('/user/profile', protect, updateProfile);
```

---

## 安全措施

### 1. 密码安全
- ✅ 使用 bcrypt 加密，12 轮加密
- ✅ 密码不以明文存储
- ✅ 密码不在响应中返回
- ✅ 最小密码长度要求（6位）

### 2. Token 安全
- ✅ 使用 JWT 标准
- ✅ Token 有效期 7 天
- ✅ Token 包含用户 ID
- ✅ 使用环境变量存储密钥

### 3. 输入验证
- ✅ 前端验证用户输入
- ✅ 后端再次验证
- ✅ 防止 SQL 注入（使用参数化查询）
- ✅ 防止 XSS 攻击

### 4. 错误处理
- ✅ 不泄露敏感信息
- ✅ 统一的错误响应格式
- ✅ 详细的日志记录

---

## 测试账号

### 预置测试账号
| 用户名 | 邮箱 | 密码 | 角色 |
|--------|------|------|------|
| admin | admin@example.com | admin123 | admin |
| teacher1 | teacher1@example.com | admin123 | teacher |
| student1 | student1@example.com | admin123 | student |

### 测试步骤

#### 1. 测试注册
```bash
# 使用测试工具或小程序
1. 打开登录页面
2. 切换到注册模式
3. 输入用户名: testuser
4. 输入密码: 123456
5. 确认密码: 123456
6. 点击注册
7. 验证是否跳转到首页
8. 检查数据库是否有新用户记录
```

#### 2. 测试登录
```bash
# 使用刚注册的账号登录
1. 打开登录页面
2. 输入用户名: testuser
3. 输入密码: 123456
4. 点击登录
5. 验证是否跳转到首页
6. 检查是否能访问需要登录的功能
```

#### 3. 测试认证
```bash
# 测试受保护的接口
1. 登录后访问"我的订单"
2. 尝试发布订单
3. 尝试接单
4. 验证所有操作是否正常
```

---

## 常见问题

### 1. 注册失败：用户名已存在
**原因**: 数据库中已有相同用户名  
**解决**: 更换用户名或删除旧用户

### 2. 登录失败：密码错误
**原因**: 输入的密码与数据库中的加密密码不匹配  
**解决**: 确认密码正确或重置密码

### 3. Token 过期
**原因**: Token 有效期为 7 天，超过后自动过期  
**解决**: 重新登录获取新 Token

### 4. 未授权错误
**原因**: Token 无效或未提供  
**解决**: 检查 Token 是否正确保存和发送

---

## 开发建议

### 1. 增强安全性
- 添加验证码功能
- 实现手机号验证
- 添加邮箱验证
- 实现密码找回功能
- 添加登录日志

### 2. 优化用户体验
- 记住密码功能
- 自动登录
- 第三方登录（微信、QQ等）
- 生物识别登录

### 3. 完善功能
- 用户资料完善
- 实名认证
- 账号安全设置
- 登录设备管理

---

## 总结

本系统实现了完整的用户注册和登录功能：

✅ **注册功能**
- 用户名密码注册
- 密码加密存储
- 自动登录

✅ **登录功能**
- 用户名/邮箱登录
- 密码验证
- JWT Token 认证

✅ **安全措施**
- bcrypt 密码加密
- JWT 身份认证
- 输入验证
- 错误处理

✅ **数据持久化**
- MySQL 数据库存储
- 本地 Token 缓存
- 全局状态管理

系统已经可以正常使用，用户注册后信息会保存到 MySQL 数据库，下次登录时会从数据库验证身份！
