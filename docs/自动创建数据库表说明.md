# 自动创建数据库表说明

## 功能说明

系统现在支持**自动创建缺失的数据库表**，无需手动运行初始化脚本。

## 自动创建的表

### 1. wallet_transactions（钱包交易记录表）

**触发时机：**
- 首次访问钱包页面时
- 查询钱包明细时
- 创建交易记录时

**表结构：**
```sql
CREATE TABLE wallet_transactions (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  type ENUM('income', 'expense', 'freeze', 'unfreeze', 'withdraw', 'recharge'),
  amount DECIMAL(10, 2) NOT NULL,
  balance_before DECIMAL(10, 2) DEFAULT 0,
  balance_after DECIMAL(10, 2) DEFAULT 0,
  title VARCHAR(100) NOT NULL,
  description TEXT,
  related_type VARCHAR(50),
  related_id INT,
  status ENUM('pending', 'completed', 'failed') DEFAULT 'completed',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 2. withdraw_requests（提现申请表）

**触发时机：**
- 用户首次申请提现时
- 查询提现记录时
- 管理员查看提现列表时

**表结构：**
```sql
CREATE TABLE withdraw_requests (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  amount DECIMAL(10, 2) NOT NULL,
  account VARCHAR(100) NOT NULL,
  account_type ENUM('wechat', 'alipay', 'bank') DEFAULT 'wechat',
  real_name VARCHAR(50),
  status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending',
  reject_reason TEXT,
  reviewer_id INT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  reviewed_at TIMESTAMP NULL,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

## 工作原理

### 1. 错误检测
当执行数据库查询时，如果遇到以下错误：
- `ER_NO_SUCH_TABLE` - MySQL错误代码
- 错误信息包含 "doesn't exist"

系统会自动识别为表不存在。

### 2. 自动创建
检测到表不存在后：
1. 输出日志：`⚠️ [表名] 表不存在，正在自动创建...`
2. 执行 `CREATE TABLE IF NOT EXISTS` 语句
3. 输出日志：`✅ [表名] 表创建成功`
4. 重新执行原始查询

### 3. 透明处理
整个过程对用户透明，用户无需关心表是否存在，系统会自动处理。

## 修改的文件

### 后端模型
1. **errand-back/src/models/WalletTransaction.js**
   - `getUserTransactions()` - 添加自动创建表逻辑
   - `createTable()` - 新增表创建方法

2. **errand-back/src/models/WithdrawRequest.js**
   - `create()` - 添加自动创建表逻辑
   - `findByUserId()` - 添加自动创建表逻辑
   - `createTable()` - 新增表创建方法

### 后端控制器
3. **errand-back/src/controllers/user.controller.js**
   - `getWalletDetails()` - 添加表不存在时返回空列表的处理

## 优势

### 1. 零配置
- 无需手动运行初始化脚本
- 首次使用自动创建所需表
- 降低部署复杂度

### 2. 容错性强
- 即使表被误删，也能自动恢复
- 开发环境和生产环境统一处理
- 减少人为操作错误

### 3. 用户体验好
- 用户无感知
- 不会因为表不存在而报错
- 自动降级处理（返回空列表）

## 注意事项

### 1. 首次创建会有延迟
首次访问时需要创建表，可能会有1-2秒的延迟，这是正常现象。

### 2. 日志输出
创建表时会在控制台输出日志，便于调试和监控：
```
⚠️ wallet_transactions 表不存在，正在自动创建...
✅ wallet_transactions 表创建成功
```

### 3. 数据库权限
确保数据库用户有 `CREATE TABLE` 权限。

### 4. 并发创建
如果多个请求同时触发表创建，`CREATE TABLE IF NOT EXISTS` 语句会确保只创建一次。

## 测试建议

### 1. 测试自动创建
```sql
-- 删除表
DROP TABLE IF EXISTS wallet_transactions;
DROP TABLE IF EXISTS withdraw_requests;

-- 访问钱包页面，观察表是否自动创建
```

### 2. 测试空数据
- 新创建的表没有数据
- 应该显示"暂无记录"而不是报错

### 3. 测试正常流程
- 完成一个订单
- 查看钱包明细是否正常显示
- 申请提现是否正常

## 回退方案

如果需要禁用自动创建功能，可以：

1. 手动创建表（运行 `init-wallet-tables.bat`）
2. 移除模型中的自动创建逻辑
3. 让系统直接报错，提示用户运行初始化脚本

但**不推荐**这样做，因为自动创建提供了更好的用户体验。

## 总结

现在你可以直接打开钱包页面，系统会自动处理一切！无需担心表是否存在，无需手动运行脚本。
