# 订单支付功能说明

## 功能概述

实现了完整的订单支付流程：
1. **发布订单时** - 检查用户余额，余额足够则冻结订单金额
2. **确认完成时** - 将冻结金额转给骑手
3. **取消订单时** - 退还冻结金额给发布者

## 业务流程

```
用户发布订单
    ↓
检查余额是否足够
    ↓ (余额不足则提示充值)
冻结订单金额 (balance → frozen_balance)
    ↓
创建订单
    ↓
骑手接单
    ↓
骑手标记完成 (status: accepted → completing)
    ↓
发布者确认完成 (status: completing → completed)
    ↓
转账给骑手 (frozen_balance → 骑手的 balance)
```

## 注意事项

### 1. 旧订单不受影响
在此功能上线之前发布的订单，没有冻结金额，所以：
- 确认完成时会提示"冻结余额不足"
- 这是正常的，因为旧订单没有预先冻结金额

### 2. 新订单测试步骤
1. 确保用户有足够余额（可以通过充值功能添加）
2. 发布新订单，设置订单金额
3. 发布成功后，用户余额会减少，冻结余额会增加
4. 骑手接单并标记完成
5. 发布者确认完成
6. 骑手余额增加，发布者冻结余额减少

### 3. 查看余额变化
- 前端：钱包页面可以查看余额和冻结余额
- 后端日志：会打印详细的余额变化信息

## 相关文件

### 后端
- `errand-back/src/controllers/order.controller.js` - 订单控制器
- `errand-back/src/models/User.js` - 用户模型（钱包方法）
- `errand-back/src/models/Order.js` - 订单模型

### 前端
- `errand-front/pages/publish/publish.js` - 发布页面
- `errand-front/pages/wallet/wallet.js` - 钱包页面

### 数据库
- `users` 表：balance, frozen_balance, total_income, total_expense
- `wallet_transactions` 表：交易记录

## 测试脚本

```bash
# 更新数据库表结构
cd errand-back
node update-wallet-tables.js

# 测试钱包支付流程
node test-wallet-flow.js
```

## 常见问题

### Q: 发布订单提示"余额不足"
A: 用户需要先充值，确保余额大于订单金额

### Q: 确认完成提示"冻结余额不足"
A: 这是旧订单（功能上线前发布的），没有预先冻结金额。新发布的订单不会有这个问题。

### Q: 余额没有变化
A: 检查后端日志，查看是否有错误信息。确保数据库表结构正确（运行 update-wallet-tables.js）
