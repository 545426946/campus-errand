# 认证历史记录功能 - 快速指南

## 🚀 快速开始

### 1. 确保数据库已更新
```bash
cd errand-back

# 创建认证表
node create-certifications-table.js

# 添加用户表字段
node add-certification-columns.js

# 验证数据库
node test-certification-history.js
```

### 2. 创建测试数据（可选）
```bash
# 创建测试认证记录
node create-test-certifications.js
```

### 3. 启动服务
```bash
# 启动后端服务
node server.js

# 或使用开发模式
npm run dev
```

### 4. 测试功能
1. 打开微信开发者工具
2. 登录测试账号
3. 进入"我的" -> "身份认证"
4. 点击"查看历史记录"

## 📱 用户使用流程

### 查看历史记录
```
我的页面
  ↓
身份认证
  ↓
查看历史记录按钮
  ↓
历史记录列表
```

### 查看详情
```
历史记录列表
  ↓
选择一条记录
  ↓
点击"查看详情"
  ↓
详情弹窗
```

### 重新认证
```
历史记录列表
  ↓
找到被拒绝的记录
  ↓
点击"重新认证"
  ↓
返回认证页面
  ↓
重新填写提交
```

## 🎯 核心功能

### 1. 历史记录展示
- ✅ 显示所有认证申请记录
- ✅ 按时间倒序排列
- ✅ 状态标签（审核中/已通过/已拒绝）
- ✅ 完整的认证信息
- ✅ 身份证号脱敏

### 2. 详情查看
- ✅ 弹窗显示完整信息
- ✅ 包含所有提交的字段
- ✅ 显示时间信息
- ✅ 显示拒绝原因（如有）

### 3. 重新认证
- ✅ 被拒绝记录可重新认证
- ✅ 一键返回认证页面
- ✅ 保留原有信息

### 4. 下拉刷新
- ✅ 支持下拉刷新
- ✅ 实时更新数据

## 🔧 技术要点

### 前端实现
```javascript
// 获取历史记录
const res = await certificationAPI.getCertificationHistory();

// 格式化时间
formatTime(dateString) {
  const date = new Date(dateString);
  return `${year}-${month}-${day} ${hours}:${minutes}`;
}

// 查看详情
onViewDetail(e) {
  const item = e.currentTarget.dataset.item;
  wx.showModal({
    title: '认证详情',
    content: content
  });
}
```

### 后端实现
```javascript
// 获取历史记录
exports.getCertificationHistory = async (req, res, next) => {
  const userId = req.user.id;
  const history = await Certification.getHistoryByUserId(userId);
  
  // 脱敏处理
  const safeHistory = history.map(cert => ({
    ...cert,
    id_card: cert.id_card.replace(/(\d{6})\d{8}(\d{4})/, '$1********$2')
  }));
  
  res.json({ success: true, code: 0, data: safeHistory });
};
```

### 数据库查询
```sql
-- 获取用户历史记录
SELECT * FROM certifications 
WHERE user_id = ? 
ORDER BY created_at DESC
```

## 📊 状态说明

### 认证状态
| 状态 | 说明 | 颜色 | 操作 |
|------|------|------|------|
| pending | 审核中 | 🟠 橙色 | 等待审核 |
| approved | 已通过 | 🟢 绿色 | 查看详情 |
| rejected | 已拒绝 | 🔴 红色 | 重新认证 |

### 认证类型
| 类型 | 说明 | 必填字段 |
|------|------|---------|
| student | 学生 | 学号、学院、专业、年级 |
| teacher | 教师 | 工号、部门 |
| staff | 职工 | 工号、部门 |

## 🎨 UI展示

### 历史记录卡片
```
┌─────────────────────────────┐
│ 学生认证          [已通过]   │
│ 张三                         │
│ ─────────────────────────   │
│ 学校：北京大学               │
│ 学号：2023001                │
│ 学院：计算机学院             │
│ 专业：软件工程               │
│ 年级：2023级                 │
│ ─────────────────────────   │
│ 提交时间：2024-01-01 10:00  │
│ 审核时间：2024-01-02 15:30  │
│ ─────────────────────────   │
│ [查看详情]                   │
└─────────────────────────────┘
```

### 被拒绝记录
```
┌─────────────────────────────┐
│ 学生认证        [已拒绝]     │
│ 张三                         │
│ ─────────────────────────   │
│ 学校：北京大学               │
│ ─────────────────────────   │
│ 提交时间：2024-01-01 10:00  │
│ 审核时间：2024-01-02 15:30  │
│                              │
│ ⚠️ 拒绝原因：                │
│ 上传的学生证照片不清晰，     │
│ 请重新上传清晰的照片         │
│ ─────────────────────────   │
│ [查看详情] [重新认证]        │
└─────────────────────────────┘
```

## 🔐 安全特性

### 1. 身份证号脱敏
```
原始：110101199001011234
脱敏：110101********1234
```

### 2. 权限控制
- ✅ 需要登录才能访问
- ✅ 仅能查看自己的记录
- ✅ Token验证

### 3. 数据保护
- ✅ SQL注入防护
- ✅ XSS防护
- ✅ 敏感信息加密

## 📝 API文档

### 获取历史记录
```
GET /api/certification/history
```

**请求头：**
```
Authorization: Bearer {token}
```

**响应示例：**
```json
{
  "success": true,
  "code": 0,
  "data": [
    {
      "id": 1,
      "type": "student",
      "real_name": "张三",
      "id_card": "110101********1234",
      "student_id": "2023001",
      "school": "北京大学",
      "college": "计算机学院",
      "major": "软件工程",
      "grade": "2023级",
      "status": "approved",
      "submitted_at": "2024-01-01T10:00:00.000Z",
      "reviewed_at": "2024-01-02T15:30:00.000Z"
    }
  ]
}
```

## 🐛 常见问题

### Q1: 历史记录按钮不显示？
**A:** 确保用户有认证记录，检查 `certStatus !== 'none'` 条件。

### Q2: 身份证号没有脱敏？
**A:** 检查后端控制器的脱敏逻辑，确保正则表达式正确。

### Q3: 时间格式不正确？
**A:** 检查前端的 `formatTime` 函数，确保时区处理正确。

### Q4: 无法查看其他用户的记录？
**A:** 这是正常的安全限制，每个用户只能查看自己的记录。

### Q5: 下拉刷新不工作？
**A:** 检查 `enablePullDownRefresh` 配置和 `onPullDownRefresh` 方法。

## 📚 相关文档

- [认证历史记录功能说明.md](./认证历史记录功能说明.md) - 详细功能说明
- [认证历史记录测试清单.md](./认证历史记录测试清单.md) - 完整测试清单
- [身份认证系统说明.md](./身份认证系统说明.md) - 认证系统总览

## 🎉 完成检查清单

- [ ] 数据库表已创建
- [ ] 用户表字段已添加
- [ ] 后端服务已启动
- [ ] 前端页面已注册
- [ ] 测试数据已创建
- [ ] 功能测试通过
- [ ] UI样式正确
- [ ] 安全性验证通过

## 💡 优化建议

### 短期优化
1. 添加分页功能（记录较多时）
2. 添加筛选功能（按状态筛选）
3. 优化加载性能

### 长期优化
1. 添加导出功能
2. 添加统计图表
3. 添加消息推送
4. 支持批量操作

## 📞 技术支持

如有问题，请查看：
1. 控制台错误日志
2. 网络请求响应
3. 数据库查询结果
4. 相关文档说明

---

**最后更新：** 2024-01-01
**版本：** v1.0.0
