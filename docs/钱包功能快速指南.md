# 钱包功能快速指南

## 快速开始

### 1. 初始化钱包系统
```bash
# Windows
init-wallet.bat

# 或手动执行
cd errand-back
node init-wallet-system.js
```

### 2. 启动服务
```bash
# 启动后端
cd errand-back
npm run dev

# 启动前端
# 在微信开发者工具中打开 errand-front 目录
```

### 3. 测试账号
- 用户ID: 15
- 用户名: user15
- 初始余额: ¥100.00

## 功能测试

### 充值测试
1. 打开小程序，进入"我的"页面
2. 点击"钱包"进入钱包页面
3. 点击"充值"按钮
4. 输入金额（如：50）
5. 确认充值
6. ✅ 查看余额是否增加到 ¥150.00
7. ✅ 查看交易记录中是否有充值记录

### 提现测试
1. 在钱包页面点击"提现"按钮
2. 输入金额（如：30）
3. 确认提现
4. ✅ 查看可用余额是否减少
5. ✅ 查看冻结余额是否增加
6. 点击"提现记录"查看申请状态
7. ✅ 确认提现申请状态为"待审核"

### 取消提现测试
1. 在提现记录页面找到待审核的申请
2. 点击"取消"按钮
3. 确认取消
4. ✅ 查看申请状态变为"已取消"
5. ✅ 查看可用余额是否恢复
6. ✅ 查看冻结余额是否减少

### 交易记录测试
1. 在钱包页面查看交易记录
2. ✅ 确认显示所有交易（充值、提现、冻结等）
3. ✅ 确认每条记录显示正确的金额和时间
4. ✅ 确认收入显示为绿色，支出显示为红色

## 管理员功能测试

### 提现审核（需要管理员权限）
1. 登录管理员账号
2. 进入管理后台
3. 找到提现审核模块
4. 查看待审核的提现申请
5. 选择"批准"或"拒绝"
6. 填写审核备注
7. 提交审核

**批准提现**
- ✅ 用户的冻结余额减少
- ✅ 提现申请状态变为"已完成"
- ✅ 用户收到通知

**拒绝提现**
- ✅ 用户的冻结余额解冻
- ✅ 可用余额恢复
- ✅ 提现申请状态变为"已拒绝"
- ✅ 用户收到通知

## 常见问题

### Q1: 充值后余额没有变化？
**A**: 检查以下几点：
1. 查看浏览器控制台是否有错误
2. 确认后端服务是否正常运行
3. 检查数据库连接是否正常
4. 查看后端日志 `errand-back/logs/`

### Q2: 提现申请提交失败？
**A**: 可能的原因：
1. 余额不足
2. 已有待审核的提现申请
3. 提现金额小于最小限额（¥1）
4. 网络连接问题

### Q3: 提现记录页面显示空白？
**A**: 检查：
1. 是否有提现记录
2. API接口是否正常
3. 查看控制台错误信息

### Q4: 管理员无法审核提现？
**A**: 确认：
1. 是否有管理员权限
2. 提现申请是否为"待审核"状态
3. 后端路由是否正确配置

## API端点

### 用户端
- `GET /api/user/wallet` - 获取钱包信息
- `GET /api/user/wallet/details` - 获取交易记录
- `POST /api/user/wallet/recharge` - 充值
- `POST /api/withdraw` - 创建提现申请
- `GET /api/withdraw/my` - 获取我的提现记录
- `POST /api/withdraw/:id/cancel` - 取消提现申请
- `GET /api/withdraw/stats` - 获取提现统计

### 管理员端
- `GET /api/withdraw/admin/all` - 获取所有提现申请
- `POST /api/withdraw/admin/:id/review` - 审核提现申请

## 数据库表

### wallet_transactions (钱包交易表)
- 记录所有资金变动
- 包含交易前后余额
- 支持多种交易类型

### withdraw_requests (提现申请表)
- 记录所有提现申请
- 包含审核状态和备注
- 关联用户和管理员

## 前端页面

### 钱包主页
- 文件: `errand-front/pages/wallet/wallet.*`
- 功能: 显示余额、充值、提现、交易记录

### 提现记录页
- 文件: `errand-front/pages/wallet/withdraw-list.*`
- 功能: 查看提现申请、取消申请、筛选状态

## 后端文件

### 模型
- `errand-back/src/models/WalletTransaction.js` - 钱包交易模型
- `errand-back/src/models/WithdrawRequest.js` - 提现申请模型

### 控制器
- `errand-back/src/controllers/user.controller.js` - 用户钱包控制器
- `errand-back/src/controllers/withdraw.controller.js` - 提现控制器

### 服务
- `errand-back/src/services/payment.service.js` - 支付服务

### 路由
- `errand-back/src/routes/user.routes.js` - 用户路由
- `errand-back/src/routes/withdraw.routes.js` - 提现路由

## 安全注意事项

1. **余额操作使用事务**: 确保数据一致性
2. **行级锁**: 防止并发修改余额
3. **提现审核**: 防止恶意提现
4. **金额验证**: 前后端都要验证金额
5. **日志记录**: 记录所有关键操作

## 性能优化

1. **分页查询**: 交易记录和提现记录都支持分页
2. **索引优化**: 在user_id、status、created_at上建立索引
3. **缓存**: 可以缓存用户余额信息
4. **异步处理**: 提现到账可以使用队列异步处理

## 下一步

完成基础测试后，可以：
1. 集成真实的支付接口（微信支付、支付宝）
2. 添加提现手续费功能
3. 实现余额支付订单
4. 添加红包功能
5. 实现积分系统
6. 添加优惠券功能

## 相关文档

- [钱包支付与提现系统说明](./钱包支付与提现系统说明.md)
- [后端API文档](./BACKEND_APIS.md)
- [项目结构说明](./项目结构说明.md)

## 技术支持

遇到问题？
1. 查看控制台错误信息
2. 检查后端日志
3. 查看数据库数据
4. 参考完整文档
