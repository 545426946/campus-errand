# 钱包支付与提现系统说明

## 功能概述

校园跑腿平台的钱包系统提供完整的资金管理功能，包括充值、提现、交易记录查询等。

## 核心功能

### 1. 钱包管理

#### 余额类型
- **可用余额**: 可以直接使用的金额
- **冻结余额**: 提现申请中或订单保证金冻结的金额
- **累计收入**: 历史总收入金额
- **累计支出**: 历史总支出金额

#### 钱包信息查询
```javascript
// API: GET /api/user/wallet
// 返回用户的钱包信息
{
  "balance": "150.50",      // 可用余额
  "frozen": "20.00",        // 冻结余额
  "total": "170.50",        // 总金额
  "totalIncome": "200.00",  // 累计收入
  "totalExpense": "29.50"   // 累计支出
}
```

### 2. 充值功能

#### 充值方式
- 微信支付（模拟）
- 支付宝支付（模拟）

#### 充值限制
- 单次最小充值: ¥1
- 单次最大充值: ¥10,000

#### 充值流程
1. 用户输入充值金额
2. 选择支付方式
3. 调用支付接口（模拟）
4. 支付成功后更新余额
5. 创建充值交易记录

```javascript
// API: POST /api/user/wallet/recharge
{
  "amount": 100.00,
  "paymentMethod": "wechat"  // wechat | alipay
}
```

### 3. 提现功能

#### 提现流程
1. **用户申请提现**
   - 输入提现金额
   - 选择提现账户（微信/支付宝/银行卡）
   - 提交申请

2. **系统冻结金额**
   - 从可用余额扣除提现金额
   - 转入冻结余额
   - 创建提现申请记录

3. **管理员审核**
   - 查看提现申请列表
   - 审核通过或拒绝
   - 填写审核备注

4. **处理结果**
   - **审核通过**: 从冻结余额扣除，标记为已完成
   - **审核拒绝**: 解冻金额，退回可用余额

#### 提现限制
- 最小提现金额: ¥1
- 同时只能有一个待审核的提现申请
- 余额不足时无法申请

#### 提现API

**创建提现申请**
```javascript
// API: POST /api/withdraw
{
  "amount": 50.00,
  "account": "微信",
  "accountType": "wechat",  // wechat | alipay | bank
  "realName": "张三"
}
```

**查询提现记录**
```javascript
// API: GET /api/withdraw/my?page=1&pageSize=20&status=pending
// status: pending | approved | completed | rejected | cancelled
```

**取消提现申请**
```javascript
// API: POST /api/withdraw/:id/cancel
// 只能取消待审核状态的申请
```

### 4. 交易记录

#### 交易类型
- `recharge`: 充值
- `withdraw`: 提现
- `income`: 收入（订单完成）
- `expense`: 支出（发布订单）
- `freeze`: 冻结（提现申请）
- `unfreeze`: 解冻（取消提现）

#### 交易记录查询
```javascript
// API: GET /api/user/wallet/details?page=1&pageSize=20&type=income
// type: 可选，筛选交易类型
```

#### 交易记录字段
```javascript
{
  "id": 1,
  "type": "recharge",
  "amount": "100.00",
  "title": "账户充值",
  "description": "通过微信充值 ¥100.00",
  "createTime": "2024-01-05 10:30:00",
  "status": "completed",
  "balanceBefore": "50.50",
  "balanceAfter": "150.50",
  "orderId": null
}
```

### 5. 管理员功能

#### 提现审核
```javascript
// API: GET /api/withdraw/admin/all?page=1&status=pending
// 获取所有提现申请

// API: POST /api/withdraw/admin/:id/review
{
  "action": "approve",  // approve | reject
  "note": "审核通过"     // 审核备注
}
```

#### 提现统计
```javascript
// API: GET /api/withdraw/stats
{
  "totalCount": 10,      // 总申请数
  "pendingCount": 2,     // 待审核数
  "completedCount": 7,   // 已完成数
  "rejectedCount": 1,    // 已拒绝数
  "totalAmount": "500.00" // 已提现总额
}
```

## 数据库设计

### 钱包交易表 (wallet_transactions)
```sql
CREATE TABLE wallet_transactions (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  type ENUM('recharge', 'withdraw', 'income', 'expense', 'freeze', 'unfreeze'),
  amount DECIMAL(10,2) NOT NULL,
  balance_before DECIMAL(10,2) NOT NULL,
  balance_after DECIMAL(10,2) NOT NULL,
  title VARCHAR(200) NOT NULL,
  description TEXT,
  order_id INT NULL,
  status ENUM('pending', 'completed', 'failed', 'cancelled'),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 提现申请表 (withdraw_requests)
```sql
CREATE TABLE withdraw_requests (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  amount DECIMAL(10,2) NOT NULL,
  account VARCHAR(200) NOT NULL,
  account_type ENUM('wechat', 'alipay', 'bank'),
  real_name VARCHAR(100),
  status ENUM('pending', 'approved', 'completed', 'rejected', 'cancelled'),
  admin_id INT NULL,
  admin_note TEXT,
  completed_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

## 前端页面

### 钱包主页
- 路径: `/pages/wallet/wallet`
- 功能: 显示余额、充值、提现、交易记录

### 提现记录页
- 路径: `/pages/wallet/withdraw-list`
- 功能: 查看提现申请列表、取消申请

## 安全机制

### 1. 余额安全
- 使用数据库事务确保余额操作的原子性
- 行级锁防止并发修改
- 余额变动前后都有记录

### 2. 提现安全
- 提现金额立即冻结
- 需要管理员审核
- 审核拒绝后自动解冻

### 3. 交易记录
- 所有资金变动都有详细记录
- 记录交易前后余额
- 支持追溯和审计

## 初始化步骤

1. **运行数据库迁移**
```bash
cd errand-back
node init-wallet-system.js
```

2. **启动后端服务**
```bash
npm run dev
```

3. **测试账号**
- 用户ID: 15
- 初始余额: ¥100.00

## 测试流程

### 1. 测试充值
1. 打开钱包页面
2. 点击"充值"按钮
3. 输入金额（如 50）
4. 确认充值
5. 查看余额是否增加
6. 查看交易记录

### 2. 测试提现
1. 打开钱包页面
2. 点击"提现"按钮
3. 输入金额（如 30）
4. 确认提现
5. 查看余额是否冻结
6. 点击"提现记录"查看申请状态

### 3. 测试提现审核（管理员）
1. 登录管理员账号
2. 进入提现审核页面
3. 查看待审核申请
4. 批准或拒绝申请
5. 查看用户余额变化

## 注意事项

1. **支付集成**: 当前为模拟支付，实际应用需要集成真实的支付接口
2. **提现到账**: 当前为即时到账，实际应用需要对接银行或第三方支付
3. **手续费**: 可以在提现时扣除一定比例的手续费
4. **限额管理**: 可以设置每日提现限额、单笔限额等
5. **实名认证**: 建议提现前要求用户完成实名认证

## 扩展功能

### 可以添加的功能
1. 提现手续费计算
2. 每日提现限额
3. 提现到账时间预估
4. 余额支付订单
5. 红包功能
6. 积分兑换
7. 优惠券系统
8. 资金流水导出

## API文档

完整的API文档请参考 `docs/BACKEND_APIS.md`

## 技术支持

如有问题，请查看：
- 后端日志: `errand-back/logs/`
- 数据库日志: MySQL错误日志
- 前端控制台: 微信开发者工具

## 更新日志

### v1.0.0 (2024-01-05)
- ✅ 实现钱包基础功能
- ✅ 实现充值功能（模拟）
- ✅ 实现提现申请和审核
- ✅ 实现交易记录查询
- ✅ 实现余额冻结/解冻机制
- ✅ 添加提现记录页面
- ✅ 完善数据库设计
