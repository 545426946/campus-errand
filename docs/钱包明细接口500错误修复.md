# 钱包明细接口 500 错误修复

## 问题描述

前端调用 `/api/user/wallet/details` 接口时返回 500 错误：
```
GET http://localhost:3000/api/user/wallet/details?page=1&pageSize=10 500 (Internal Server Error)
```

## 问题原因

在 `WalletTransaction.js` 模型的 `getUserTransactions` 方法中，使用了参数绑定的方式传递 `LIMIT` 和 `OFFSET` 值：

```javascript
// 错误的写法
const [rows] = await db.execute(
  `SELECT * FROM wallet_transactions 
   ${whereClause} 
   ORDER BY created_at DESC 
   LIMIT ? OFFSET ?`,
  [...params, limitValue, offsetValue]
);
```

MySQL2 驱动在某些情况下对 `LIMIT` 和 `OFFSET` 的参数绑定支持不完善，导致 SQL 执行失败。

## 解决方案

将 `LIMIT` 和 `OFFSET` 改为直接拼接到 SQL 语句中（已经过 parseInt 处理，安全）：

```javascript
// 正确的写法
const limitValue = parseInt(pageSize);
const offsetValue = parseInt(offset);

const [rows] = await db.execute(
  `SELECT * FROM wallet_transactions 
   ${whereClause} 
   ORDER BY created_at DESC 
   LIMIT ${limitValue} OFFSET ${offsetValue}`,
  params
);
```

## 修改文件

- `errand-back/src/models/WalletTransaction.js`

## 测试结果

修复后接口正常返回：
```json
{
  "success": true,
  "code": 0,
  "data": {
    "list": [],
    "total": 0,
    "page": 1,
    "pageSize": 10,
    "hasMore": false
  },
  "message": "获取钱包明细成功"
}
```

## 注意事项

1. 确保后端服务器使用 `node server.js` 启动（不是 `node src/app.js`）
2. `limitValue` 和 `offsetValue` 已经通过 `parseInt()` 处理，防止 SQL 注入
3. 如果表不存在，代码会自动创建 `wallet_transactions` 表

## 相关接口

- ✅ GET `/api/user/wallet` - 获取钱包信息
- ✅ GET `/api/user/wallet/details` - 获取钱包明细（已修复）
- ✅ POST `/api/user/wallet/recharge` - 充值
- ✅ POST `/api/user/wallet/withdraw` - 提现

修复完成时间：2026-01-06
