# 钱包系统修改说明

## 修改概述

根据需求，对钱包系统进行了以下修改：

### 1. 移除充值功能

**前端修改：**
- `errand-front/pages/wallet/wallet.js`
  - 删除了 `onRecharge()` 方法
  - 删除了 `doRecharge()` 方法
  
- `errand-front/pages/wallet/wallet.wxml`
  - 移除了"充值"按钮，只保留"提现"按钮

### 2. 订单完成后的支付流程

**后端修改：**
- `errand-back/src/controllers/order.controller.js`
  - 修改了 `confirmCompleteOrder()` 方法
  - 发布者确认订单完成时：
    1. 发布者账户记录支出（订单金额）
    2. 接单者账户增加收入（订单金额）
    3. 自动创建钱包交易记录

- `errand-back/src/models/User.js`
  - 新增 `addWalletTransaction()` 方法
  - 支持事务处理，确保余额变动和交易记录的一致性
  - 自动更新用户的 `balance`、`total_income`、`total_expense` 字段

### 3. 提现审核功能

**后端修改：**
- `errand-back/src/controllers/admin.controller.js`
  - 新增 `getWithdrawRequests()` - 获取提现申请列表
  - 新增 `reviewWithdrawRequest()` - 审核提现申请
  - 审核通过：从冻结余额中扣除，记录提现交易
  - 审核拒绝：解冻余额，返还给用户

- `errand-back/src/routes/admin.routes.js`
  - 新增路由：`GET /api/admin/withdraws` - 获取提现列表
  - 新增路由：`POST /api/admin/withdraws/:id/review` - 审核提现

**前端修改：**
- `errand-admin/index.html`
  - 新增"提现管理"菜单项
  - 新增提现管理页面容器

- `errand-admin/admin.js`
  - 新增 `loadWithdraws()` - 加载提现列表
  - 新增 `displayWithdraws()` - 显示提现列表
  - 新增 `approveWithdraw()` - 通过提现申请
  - 新增 `rejectWithdraw()` - 拒绝提现申请
  - 新增 `viewWithdrawDetail()` - 查看提现详情（待实现）

## 初始化步骤

### ⚠️ 重要：首次使用需要初始化数据库表

运行以下命令初始化钱包系统：

```bash
# Windows
init-wallet-tables.bat

# 或者手动执行
cd errand-back
node create-wallet-transactions-table.js
node init-wallet-system.js
```

这将创建以下数据库表：
1. `wallet_transactions` - 钱包交易记录表
2. `withdraw_requests` - 提现申请表

并为 `users` 表添加以下字段（如果不存在）：
- `balance` - 可用余额
- `frozen_balance` - 冻结余额
- `total_income` - 累计收入
- `total_expense` - 累计支出

## 新的支付流程

### 订单流程：

1. **发布订单**
   - 用户发布订单，设置赏金金额
   - 订单状态：`pending`

2. **接单**
   - 跑腿用户接单
   - 订单状态：`accepted`

3. **完成订单**
   - 跑腿用户标记完成
   - 订单状态：`completing`（待确认）

4. **确认完成（支付）**
   - 发布者确认订单完成
   - 系统自动处理支付：
     - 发布者账户记录支出
     - 接单者账户增加收入
   - 订单状态：`completed`

### 提现流程：

1. **发起提现**
   - 用户在钱包页面申请提现
   - 系统冻结提现金额（从 `balance` 转到 `frozen_balance`）
   - 提现状态：`pending`

2. **管理员审核**
   - 管理员在后台查看提现申请
   - 选择通过或拒绝

3. **审核通过**
   - 管理员线下转账给用户
   - 点击"通过"按钮
   - 系统从 `frozen_balance` 中扣除金额
   - 记录提现交易
   - 提现状态：`approved`

4. **审核拒绝**
   - 管理员输入拒绝原因
   - 系统解冻金额（从 `frozen_balance` 返回到 `balance`）
   - 提现状态：`rejected`

## 数据库字段说明

### users 表
- `balance` - 可用余额（可提现）
- `frozen_balance` - 冻结余额（提现申请中）
- `total_income` - 累计收入
- `total_expense` - 累计支出

### wallet_transactions 表
- `type` - 交易类型：
  - `income` - 收入（完成订单）
  - `expense` - 支出（支付订单）
  - `withdraw` - 提现
- `amount` - 交易金额
- `balance_after` - 交易后余额
- `related_type` - 关联类型（order/withdraw）
- `related_id` - 关联ID

### withdraw_requests 表
- `status` - 状态：
  - `pending` - 待审核
  - `approved` - 已通过
  - `rejected` - 已拒绝
- `amount` - 提现金额
- `account` - 提现账户
- `account_type` - 账户类型（wechat/alipay/bank）
- `reject_reason` - 拒绝原因

## 注意事项

1. **事务处理**：所有涉及余额变动的操作都使用数据库事务，确保数据一致性

2. **余额验证**：
   - 支付时不检查发布者余额（订单完成即支付）
   - 提现时检查用户可用余额

3. **管理员权限**：提现审核需要管理员权限（`requireAdmin` 中间件）

4. **线下转账**：管理员需要先完成线下转账，再在系统中点击"通过"

5. **通知功能**：订单完成和提现审核都会发送通知给相关用户

## 测试建议

1. 测试订单完成后的支付流程
2. 测试提现申请和审核流程
3. 测试余额不足时的提现申请
4. 测试提现拒绝后的余额返还
5. 测试并发提现申请的处理

## 后续优化建议

1. 添加提现手续费配置
2. 添加单笔提现金额限制
3. 添加每日提现次数限制
4. 完善提现详情查看功能
5. 添加提现记录导出功能
6. 添加自动转账接口（对接微信/支付宝）
