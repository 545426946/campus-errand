# 钱包系统错误修复指南

## 错误：加载钱包明细失败

### 错误信息
```
❌ 加载钱包明细失败: Error: 服务器错误
```

### 原因分析
`wallet_transactions` 数据库表不存在，导致查询失败。

### 解决方案

#### 方法1：使用批处理文件（推荐）

在项目根目录运行：
```bash
init-wallet-tables.bat
```

这将自动：
1. 创建 `wallet_transactions` 表
2. 创建 `withdraw_requests` 表
3. 为 `users` 表添加余额相关字段

#### 方法2：手动执行

```bash
cd errand-back

# 创建钱包交易记录表
node create-wallet-transactions-table.js

# 初始化钱包系统
node init-wallet-system.js
```

### 验证修复

1. 运行初始化脚本后，重启后端服务器
2. 刷新小程序钱包页面
3. 应该能正常显示钱包信息和交易记录

### 数据库表结构

#### wallet_transactions 表
```sql
CREATE TABLE wallet_transactions (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  type ENUM('income', 'expense', 'freeze', 'unfreeze', 'withdraw', 'recharge'),
  amount DECIMAL(10, 2) NOT NULL,
  balance_before DECIMAL(10, 2) DEFAULT 0,
  balance_after DECIMAL(10, 2) DEFAULT 0,
  title VARCHAR(100) NOT NULL,
  description TEXT,
  related_type VARCHAR(50),
  related_id INT,
  status ENUM('pending', 'completed', 'failed') DEFAULT 'completed',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### withdraw_requests 表
```sql
CREATE TABLE withdraw_requests (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  amount DECIMAL(10, 2) NOT NULL,
  account VARCHAR(100) NOT NULL,
  account_type ENUM('wechat', 'alipay', 'bank') DEFAULT 'wechat',
  status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending',
  reject_reason TEXT,
  reviewer_id INT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  reviewed_at TIMESTAMP NULL
);
```

### 常见问题

#### Q: 运行脚本后仍然报错？
A: 
1. 检查数据库连接配置（.env文件）
2. 确保MySQL服务正在运行
3. 重启后端服务器

#### Q: 表已存在但仍然报错？
A: 
1. 检查表结构是否完整
2. 运行 `SHOW COLUMNS FROM wallet_transactions;` 查看字段
3. 如果字段不匹配，删除表后重新创建

#### Q: 如何删除表重新创建？
A:
```sql
DROP TABLE IF EXISTS wallet_transactions;
DROP TABLE IF EXISTS withdraw_requests;
```
然后重新运行初始化脚本。

### 测试数据

初始化完成后，可以通过以下方式测试：

1. **测试订单支付**
   - 创建一个订单
   - 接单并完成
   - 发布者确认完成
   - 检查双方钱包余额和交易记录

2. **测试提现**
   - 在钱包页面申请提现
   - 管理员后台审核
   - 检查余额变化

### 相关文件

- 初始化脚本：`init-wallet-tables.bat`
- 表创建脚本：`errand-back/create-wallet-transactions-table.js`
- 钱包系统初始化：`errand-back/init-wallet-system.js`
- 详细说明：`docs/钱包系统修改说明.md`
