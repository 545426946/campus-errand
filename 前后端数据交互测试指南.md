# 前后端数据交互测试指南

## 一、环境准备

### 1. 后端启动
```bash
cd errand-back
npm install
npm run dev
```

后端服务将在 `http://localhost:3000` 启动

### 2. 数据库配置
确保 `.env` 文件配置正确：
```
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=errand_platform
JWT_SECRET=your_jwt_secret
JWT_EXPIRE=7d
```

### 3. 初始化数据库
```bash
cd errand-back
# 创建数据库和表结构
mysql -u root -p < database/schema.sql

# 或者使用更新脚本（如果数据库已存在）
mysql -u root -p < database/update-schema.sql

# 插入测试数据
mysql -u root -p < database/seed.sql
mysql -u root -p < database/insert-orders.sql
```

### 4. 前端配置
修改 `errand-front/utils/config.js`：
```javascript
api: {
  development: {
    baseUrl: 'http://localhost:3000/api',  // 确保指向后端地址
    timeout: 10000
  }
}
```

## 二、API接口测试

### 1. 认证接口

#### 微信登录
```
POST /api/auth/login
Content-Type: application/json

{
  "code": "test_code_123"
}

响应：
{
  "success": true,
  "code": 0,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": 1,
      "nickname": "微信用户",
      "avatar": "",
      "phone": null
    }
  },
  "message": "登录成功"
}
```

#### 邮箱登录
```
POST /api/auth/login
Content-Type: application/json

{
  "email": "student@example.com",
  "password": "password123"
}
```

### 2. 订单接口

#### 获取订单列表
```
GET /api/orders?page=1&pageSize=10&status=pending&type=1
Authorization: Bearer {token}

响应：
{
  "success": true,
  "code": 0,
  "data": [
    {
      "id": 1,
      "title": "帮我取快递",
      "description": "菜鸟驿站有个快递，帮忙取一下",
      "type": 1,
      "price": "5.00",
      "status": "pending",
      "pickup_location": "菜鸟驿站",
      "delivery_location": "东区宿舍楼",
      "contact_phone": "13800138000",
      "images": [],
      "created_at": "2024-01-01T10:00:00.000Z",
      "publisher_name": "张三",
      "publisher_avatar": ""
    }
  ],
  "message": "获取订单列表成功"
}
```

#### 获取订单详情
```
GET /api/orders/1
Authorization: Bearer {token}

响应：
{
  "success": true,
  "code": 0,
  "data": {
    "id": 1,
    "title": "帮我取快递",
    "description": "菜鸟驿站有个快递，帮忙取一下",
    "type": 1,
    "price": "5.00",
    "status": "pending",
    "pickup_location": "菜鸟驿站",
    "delivery_location": "东区宿舍楼",
    "contact_phone": "13800138000",
    "images": [],
    "user_id": 1,
    "acceptor_id": null,
    "publisher_name": "张三",
    "publisher_avatar": "",
    "publisher_phone": "13800138000",
    "created_at": "2024-01-01T10:00:00.000Z"
  },
  "message": "获取订单详情成功"
}
```

#### 创建订单
```
POST /api/orders
Authorization: Bearer {token}
Content-Type: application/json

{
  "title": "帮我买奶茶",
  "type": 2,
  "description": "一点点奶茶，波霸奶茶，少糖少冰",
  "pickupLocation": "校门口一点点",
  "deliveryLocation": "图书馆",
  "contactPhone": "13900139000",
  "price": 8.5,
  "images": []
}

响应：
{
  "success": true,
  "code": 0,
  "data": {
    "orderId": 10
  },
  "message": "订单创建成功"
}
```

#### 接单
```
POST /api/orders/1/accept
Authorization: Bearer {token}

响应：
{
  "success": true,
  "code": 0,
  "message": "接单成功"
}
```

#### 完成订单
```
POST /api/orders/1/complete
Authorization: Bearer {token}

响应：
{
  "success": true,
  "code": 0,
  "message": "订单已完成"
}
```

#### 取消订单
```
POST /api/orders/1/cancel
Authorization: Bearer {token}
Content-Type: application/json

{
  "reason": "临时有事，不需要了"
}

响应：
{
  "success": true,
  "code": 0,
  "message": "订单已取消"
}
```

#### 获取我发布的订单
```
GET /api/orders/my-publish?page=1&pageSize=10
Authorization: Bearer {token}
```

#### 获取我接受的订单
```
GET /api/orders/my-accepted?page=1&pageSize=10
Authorization: Bearer {token}
```

#### 获取订单统计
```
GET /api/orders/stats
Authorization: Bearer {token}

响应：
{
  "success": true,
  "code": 0,
  "data": {
    "published_count": 5,
    "accepted_count": 3,
    "pending_count": 2,
    "in_progress_count": 1,
    "completed_count": 7
  },
  "message": "获取订单统计成功"
}
```

### 3. 用户接口

#### 获取用户信息
```
GET /api/users/profile
Authorization: Bearer {token}

响应：
{
  "success": true,
  "code": 0,
  "data": {
    "id": 1,
    "nickname": "张三",
    "avatar": "",
    "phone": "13800138000",
    "role": "student"
  },
  "message": "获取用户信息成功"
}
```

#### 更新用户信息
```
PUT /api/user/info
Authorization: Bearer {token}
Content-Type: application/json

{
  "nickname": "新昵称",
  "avatar": "https://example.com/avatar.jpg"
}

响应：
{
  "success": true,
  "code": 0,
  "data": {
    "id": 1,
    "nickname": "新昵称",
    "avatar": "https://example.com/avatar.jpg",
    "phone": "13800138000"
  },
  "message": "更新用户信息成功"
}
```

#### 获取钱包信息
```
GET /api/user/wallet
Authorization: Bearer {token}

响应：
{
  "success": true,
  "code": 0,
  "data": {
    "balance": 0,
    "frozen": 0,
    "total": 0
  },
  "message": "获取钱包信息成功"
}
```

## 三、前端页面测试流程

### 1. 登录流程
1. 打开小程序，自动跳转到登录页面
2. 点击"微信快速登录"按钮
3. 系统自动获取微信code并调用后端登录接口
4. 登录成功后保存token和用户信息
5. 跳转到首页

### 2. 首页订单列表
1. 页面加载时自动调用 `GET /api/orders` 获取订单列表
2. 显示订单卡片，包含标题、价格、状态等信息
3. 下拉刷新重新加载数据
4. 上拉加载更多订单
5. 点击订单卡片跳转到详情页

### 3. 发布订单
1. 点击首页"发布订单"按钮
2. 填写订单信息（标题、类型、描述、地点、价格等）
3. 可选择上传图片
4. 点击"发布订单"按钮
5. 调用 `POST /api/orders` 创建订单
6. 成功后跳转到订单详情页

### 4. 订单详情
1. 从列表点击进入详情页
2. 调用 `GET /api/orders/:id` 获取订单详情
3. 显示完整订单信息
4. 根据用户身份显示不同操作按钮：
   - 待接单状态：显示"接单"按钮（非发布者）
   - 进行中状态：显示"完成订单"按钮（接单者）
   - 显示"取消订单"按钮（发布者或接单者）

### 5. 我的订单
1. 切换到"订单"标签页
2. 显示多个标签：我发布的、我接受的、待接单、进行中、已完成
3. 切换标签时调用不同的API：
   - 我发布的：`GET /api/orders/my-publish`
   - 我接受的：`GET /api/orders/my-accepted`
   - 其他：`GET /api/orders?status=xxx`

### 6. 用户中心
1. 切换到"我的"标签页
2. 显示用户头像、昵称
3. 调用 `GET /api/orders/stats` 获取订单统计
4. 显示已完成订单数、发布订单数等统计信息
5. 调用 `GET /api/user/wallet` 获取钱包余额

## 四、数据流验证

### 1. 检查数据库
```sql
-- 查看订单数据
SELECT * FROM orders ORDER BY created_at DESC LIMIT 10;

-- 查看用户数据
SELECT id, nickname, openid, phone FROM users;

-- 查看订单统计
SELECT 
  status,
  COUNT(*) as count
FROM orders
GROUP BY status;
```

### 2. 检查网络请求
在微信开发者工具中：
1. 打开"调试器"
2. 切换到"Network"标签
3. 查看所有API请求和响应
4. 确认请求URL、请求头、请求体、响应数据

### 3. 检查本地存储
在微信开发者工具中：
1. 打开"调试器"
2. 切换到"Storage"标签
3. 查看 `token` 和 `userInfo` 是否正确保存

## 五、常见问题排查

### 1. 登录失败
- 检查后端服务是否启动
- 检查数据库连接是否正常
- 检查JWT_SECRET是否配置
- 查看后端日志输出

### 2. 订单列表为空
- 检查数据库是否有订单数据
- 检查token是否有效
- 检查API请求参数是否正确
- 查看后端返回的错误信息

### 3. 接口401错误
- token过期或无效
- 请求头Authorization格式错误
- 重新登录获取新token

### 4. 跨域问题
- 确保后端已配置CORS
- 检查 `app.js` 中的 `cors()` 中间件

### 5. 数据格式错误
- 检查前端发送的数据格式
- 检查后端接收的数据类型
- 查看控制台错误信息

## 六、性能优化建议

1. **分页加载**：订单列表使用分页，避免一次加载过多数据
2. **缓存策略**：用户信息可以缓存，减少重复请求
3. **图片优化**：上传图片前进行压缩
4. **请求合并**：相关数据可以合并为一个请求
5. **错误处理**：统一的错误处理和提示

## 七、安全注意事项

1. **Token管理**：定期刷新token，避免长期有效
2. **敏感信息**：不要在前端存储敏感信息
3. **输入验证**：前后端都要进行数据验证
4. **权限控制**：后端严格检查用户权限
5. **SQL注入**：使用参数化查询，避免SQL注入

## 八、测试清单

- [ ] 用户登录功能
- [ ] 获取订单列表
- [ ] 订单详情显示
- [ ] 创建新订单
- [ ] 接单功能
- [ ] 完成订单
- [ ] 取消订单
- [ ] 我的发布订单
- [ ] 我的接受订单
- [ ] 订单统计
- [ ] 用户信息显示
- [ ] 更新用户信息
- [ ] 钱包信息
- [ ] 分页加载
- [ ] 下拉刷新
- [ ] 错误处理
- [ ] 权限验证

完成以上测试后，前后端数据交互应该完全正常！
