# 前后端数据交互配置说明

## 📋 概述

本项目已完成前后端数据交互的完整配置，前端小程序通过API从MySQL数据库动态获取和提交数据。

## 🎯 已完成的配置

### 后端 (errand-back)

#### 1. 数据库模型
- ✅ `Order.js` - 订单模型，包含完整的CRUD操作
- ✅ `User.js` - 用户模型，支持微信登录和用户信息管理

#### 2. 控制器
- ✅ `order.controller.js` - 订单业务逻辑
  - 获取订单列表（支持分页、筛选）
  - 获取订单详情
  - 创建订单
  - 接单、完成、取消订单
  - 获取我的发布/接受订单
  - 订单统计
- ✅ `auth.controller.js` - 认证逻辑（支持微信登录）
- ✅ `user.controller.js` - 用户信息管理

#### 3. 路由
- ✅ `/api/orders` - 订单相关接口
- ✅ `/api/auth` - 认证接口
- ✅ `/api/users` 和 `/api/user` - 用户接口

#### 4. 数据库
- ✅ `schema.sql` - 完整的数据库结构
- ✅ `update-schema.sql` - 数据库更新脚本
- ✅ 订单表支持JSON字段存储图片数组
- ✅ 用户表支持微信登录（openid、nickname）

### 前端 (errand-front)

#### 1. API封装
- ✅ `api/request.js` - HTTP请求封装
  - 自动添加token
  - 统一错误处理
  - 请求/响应拦截器
- ✅ `api/order.js` - 订单API
  - 获取订单列表
  - 订单详情
  - 创建/更新/删除订单
  - 接单/完成/取消订单
  - 订单统计
- ✅ `api/user.js` - 用户API
  - 登录/注册
  - 获取/更新用户信息
  - 钱包信息

#### 2. 页面实现
- ✅ `pages/index/index.js` - 首页订单列表
  - 从后端动态加载订单
  - 支持分页、筛选、搜索
  - 下拉刷新、上拉加载更多
- ✅ `pages/order/order.js` - 我的订单
  - 我发布的订单
  - 我接受的订单
  - 按状态筛选
- ✅ `pages/order/detail.js` - 订单详情
  - 动态加载订单详情
  - 根据权限显示操作按钮
- ✅ `pages/user/user.js` - 用户中心
  - 显示用户信息
  - 订单统计（从后端获取）
  - 钱包余额
- ✅ `pages/login/login.js` - 登录页面
  - 微信快速登录
  - 自动保存token
- ✅ `pages/publish/publish.js` - 发布订单
  - 表单验证
  - 图片上传
  - 提交到后端

#### 3. 配置文件
- ✅ `utils/config.js` - 全局配置
  - API地址配置
  - 状态映射
  - 常量定义
- ✅ `utils/util.js` - 工具函数
  - 时间格式化
  - 存储管理
  - 提示工具

## 🚀 快速开始

### 方式一：使用配置脚本（推荐）

```bash
# 运行配置脚本
配置前后端数据交互.bat
```

脚本会自动：
1. 安装后端依赖
2. 创建环境配置文件
3. 初始化数据库
4. 检查前端配置

### 方式二：手动配置

#### 1. 后端配置

```bash
# 进入后端目录
cd errand-back

# 安装依赖
npm install

# 配置环境变量
copy .env.example .env
# 编辑 .env 文件，设置数据库连接信息

# 初始化数据库
mysql -u root -p < database/schema.sql
mysql -u root -p < database/seed.sql
mysql -u root -p < database/insert-orders.sql

# 启动后端服务
npm run dev
```

#### 2. 前端配置

```bash
# 确认配置文件
# 编辑 errand-front/utils/config.js
# 确保 baseUrl 指向后端地址

api: {
  development: {
    baseUrl: 'http://localhost:3000/api',
    timeout: 10000
  }
}
```

#### 3. 启动测试

1. 在微信开发者工具中打开 `errand-front` 目录
2. 编译并运行小程序
3. 测试各项功能

## 📊 数据流说明

### 登录流程
```
前端 → wx.login() → 获取code
     → POST /api/auth/login {code}
     → 后端验证并创建/查找用户
     → 返回 token 和用户信息
     → 前端保存到本地存储
```

### 订单列表流程
```
前端 → GET /api/orders?page=1&pageSize=10
     → 后端查询数据库
     → 返回订单数组
     → 前端渲染列表
```

### 创建订单流程
```
前端 → 填写表单
     → POST /api/orders {订单数据}
     → 后端验证并插入数据库
     → 返回订单ID
     → 前端跳转到详情页
```

### 接单流程
```
前端 → POST /api/orders/:id/accept
     → 后端更新订单状态和接单者
     → 返回成功
     → 前端刷新订单详情
```

## 🔍 接口列表

### 认证接口
- `POST /api/auth/login` - 登录（支持微信code和邮箱密码）
- `POST /api/auth/register` - 注册
- `GET /api/auth/me` - 获取当前用户信息

### 订单接口
- `GET /api/orders` - 获取订单列表
- `GET /api/orders/:id` - 获取订单详情
- `POST /api/orders` - 创建订单
- `PUT /api/orders/:id` - 更新订单
- `DELETE /api/orders/:id` - 删除订单
- `POST /api/orders/:id/accept` - 接单
- `POST /api/orders/:id/complete` - 完成订单
- `POST /api/orders/:id/cancel` - 取消订单
- `GET /api/orders/my-publish` - 我发布的订单
- `GET /api/orders/my-accepted` - 我接受的订单
- `GET /api/orders/stats` - 订单统计

### 用户接口
- `GET /api/users/profile` - 获取用户信息
- `PUT /api/user/info` - 更新用户信息
- `GET /api/user/wallet` - 获取钱包信息

## 📝 数据库表结构

### users 表
```sql
- id: 用户ID
- nickname: 昵称
- openid: 微信openid
- avatar: 头像
- phone: 手机号
- balance: 账户余额
- role: 角色（student/teacher/admin）
- created_at: 创建时间
```

### orders 表
```sql
- id: 订单ID
- user_id: 发布者ID
- acceptor_id: 接单者ID
- title: 订单标题
- description: 订单描述
- type: 服务类型（1-快递代取，2-外卖配送，3-代购服务，4-其他）
- price: 订单价格
- pickup_location: 取货地点
- delivery_location: 送货地点
- contact_phone: 联系电话
- images: 订单图片（JSON数组）
- status: 订单状态（pending/accepted/completed/cancelled）
- created_at: 创建时间
- accepted_at: 接单时间
- completed_at: 完成时间
```

## 🧪 测试指南

详细的测试步骤请查看：[前后端数据交互测试指南.md](./前后端数据交互测试指南.md)

## ⚠️ 注意事项

1. **数据库连接**
   - 确保MySQL服务已启动
   - 检查 `.env` 文件中的数据库配置
   - 数据库名称：`errand_platform`

2. **Token管理**
   - Token有效期为7天（可在 `.env` 中配置）
   - 前端自动在请求头中添加token
   - Token过期后需要重新登录

3. **跨域配置**
   - 后端已配置CORS，允许所有来源
   - 生产环境需要限制允许的域名

4. **图片处理**
   - 订单图片存储为JSON数组
   - 前端需要实现图片上传功能
   - 建议使用云存储服务

5. **错误处理**
   - 前端统一处理HTTP错误
   - 401错误自动跳转登录页
   - 显示友好的错误提示

## 🔧 常见问题

### 1. 后端启动失败
- 检查Node.js版本（建议14+）
- 检查端口3000是否被占用
- 查看控制台错误信息

### 2. 数据库连接失败
- 检查MySQL服务状态
- 验证 `.env` 中的数据库配置
- 确认数据库已创建

### 3. 前端请求失败
- 检查后端服务是否启动
- 确认API地址配置正确
- 查看网络请求日志

### 4. Token无效
- 重新登录获取新token
- 检查JWT_SECRET配置
- 确认token格式正确

## 📚 相关文档

- [前后端数据交互测试指南.md](./前后端数据交互测试指南.md) - 详细测试步骤
- [测试指南.md](./测试指南.md) - 项目整体测试指南
- [README.md](./README.md) - 项目总体说明

## 🎉 完成状态

✅ 后端API完整实现
✅ 前端页面动态数据加载
✅ 数据库结构完善
✅ 认证和权限控制
✅ 错误处理和提示
✅ 分页和筛选功能
✅ 订单完整生命周期

所有前后端数据交互已配置完成，可以正常使用！
