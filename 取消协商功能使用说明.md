# 取消协商功能使用说明

## ✅ 功能已完成

接单后的取消协商功能和聊天界面已经完全实现！

## 🎯 核心功能

### 1. 智能取消规则

**pending状态（待接单）**
- ✅ 发布者和接单者都可以直接取消订单
- ✅ 无需协商，立即生效

**accepted状态（已接单）**
- ✅ 接单者不能直接取消
- ✅ 必须发起取消请求
- ✅ 发布者同意后才能取消

### 2. 协商流程

```
接单者 → 点击"请求取消" → 输入原因 → 发送请求
                                    ↓
发布者 → 收到通知 → 查看订单详情 → 同意/拒绝
                                    ↓
                        同意：订单取消
                        拒绝：订单继续
```

### 3. 聊天协商

- 💬 订单进入accepted状态后显示"聊天协商"按钮
- 💬 双方可以实时沟通讨论订单事宜
- 💬 系统自动发送取消请求相关通知

## 📱 使用方法

### 接单者请求取消

1. 打开订单详情页面
2. 找到"请求取消"按钮（黄色）
3. 点击后输入取消原因
4. 确认发送
5. 等待发布者处理

### 发布者处理请求

1. 收到取消请求通知
2. 打开订单详情页面
3. 看到取消请求卡片（橙色边框）
4. 查看取消原因
5. 点击"同意取消"或"拒绝"
6. 确认操作

### 双方协商沟通

1. 在订单详情页面点击"💬 聊天协商"按钮（紫色）
2. 进入聊天界面
3. 发送消息讨论订单问题
4. 达成一致后处理取消请求

## 🎨 界面说明

### 订单详情页面按钮

| 按钮 | 颜色 | 显示条件 | 功能 |
|------|------|----------|------|
| 接单 | 蓝色 | pending状态，非发布者 | 接受订单 |
| 💬 聊天协商 | 紫色渐变 | accepted状态，双方 | 进入聊天 |
| 完成订单 | 绿色 | accepted状态，接单者 | 标记完成 |
| 请求取消 | 黄色 | accepted状态，接单者，无待处理请求 | 发起取消请求 |
| 取消订单 | 红色 | pending状态，双方 | 直接取消 |

### 取消请求卡片

**外观**
- 白色背景
- 左侧橙色边框
- ⚠️ 警告图标

**内容**
- 请求标题
- 取消原因
- 操作按钮（发布者）或等待提示（接单者）

## 🔧 技术实现

### 后端API

```
POST   /api/orders/:orderId/cancel-request        创建取消请求
GET    /api/orders/:orderId/cancel-request        获取取消请求
POST   /api/orders/:orderId/cancel-request/handle 处理取消请求
```

### 数据库表

- `cancel_requests` - 存储取消请求
- `orders.cancel_request_id` - 关联当前取消请求

### 前端文件

- `errand-front/api/cancelRequest.js` - API接口
- `errand-front/pages/order/detail.js` - 订单详情逻辑
- `errand-front/pages/order/detail.wxml` - 订单详情模板
- `errand-front/pages/order/detail.wxss` - 订单详情样式
- `errand-front/pages/chat/chat.js` - 聊天页面

## 🚀 部署步骤

### 1. 创建数据库表

```bash
node errand-back/create-cancel-requests-table.js
```

### 2. 启动后端服务

```bash
cd errand-back
npm start
```

### 3. 编译前端

在微信开发者工具中：
- 点击"编译"
- 确保没有错误

### 4. 测试功能

```bash
node test-cancel-request.js
```

## 📝 注意事项

1. **权限控制**
   - 只有接单者可以发起取消请求
   - 只有发布者可以处理取消请求
   - 只有订单相关人员可以查看请求

2. **状态限制**
   - 只有accepted状态才能发起取消请求
   - 同一订单只能有一个待处理的请求
   - 请求被处理后才能发起新请求

3. **通知机制**
   - 发起请求时通知发布者
   - 处理请求时通知接单者
   - 聊天界面显示系统消息

## 🎉 功能特点

✅ 防止随意取消，保护双方权益
✅ 协商机制，促进沟通
✅ 实时聊天，方便讨论
✅ 系统通知，及时提醒
✅ 清晰界面，操作简单
✅ 完整日志，便于追溯

## 📞 问题反馈

如有问题，请查看：
- [完整功能文档](CANCEL-REQUEST-FEATURE.md)
- [聊天功能文档](CHAT-COMPLETE-RESTORATION.md)
- [API文档](errand-back/API-DOCUMENTATION.md)
