# å¾®ä¿¡ç™»å½•åŠŸèƒ½å®ç°æ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. åç«¯å®ç°

#### æ–°å¢æ–‡ä»¶
- âœ… `errand-back/src/services/wechat.service.js` - å¾®ä¿¡æœåŠ¡å°è£…
  - code2Sessionï¼šé€šè¿‡ code æ¢å– openid å’Œ session_key
  - decryptPhoneNumberï¼šè§£å¯†æ‰‹æœºå·
  - getAccessTokenï¼šè·å– access_token
  - getUnlimitedQRCodeï¼šç”Ÿæˆå°ç¨‹åºç 

- âœ… `errand-back/database/migrations/add_wechat_fields.sql` - æ•°æ®åº“è¿ç§»è„šæœ¬
  - æ·»åŠ  openidã€unionidã€session_key ç­‰å­—æ®µ
  - åˆ›å»ºç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
  - ä¿®æ”¹å­—æ®µå…è®¸ä¸ºç©º

#### ä¿®æ”¹æ–‡ä»¶
- âœ… `errand-back/src/controllers/auth.controller.js`
  - æ–°å¢ `wechatLogin` æ–¹æ³•ï¼šæ ‡å‡†å¾®ä¿¡ç™»å½•æµç¨‹
  - æ–°å¢ `bindPhone` æ–¹æ³•ï¼šç»‘å®š/æ›´æ–°æ‰‹æœºå·
  - ä¿ç•™åŸæœ‰ `login` å’Œ `register` æ–¹æ³•

- âœ… `errand-back/src/routes/auth.routes.js`
  - æ–°å¢è·¯ç”± `POST /auth/wechat/login`
  - æ–°å¢è·¯ç”± `POST /auth/wechat/bind-phone`

- âœ… `errand-back/src/models/User.js`
  - æ–°å¢ `findByOpenid` æ–¹æ³•
  - æ–°å¢ `findByUnionid` æ–¹æ³•
  - é‡æ„ `createWechatUser` æ–¹æ³•
  - æ–°å¢ `updateWechatInfo` æ–¹æ³•

- âœ… `errand-back/.env`
  - æ–°å¢ `WECHAT_APPID` é…ç½®é¡¹
  - æ–°å¢ `WECHAT_SECRET` é…ç½®é¡¹

### 2. å‰ç«¯å®ç°

#### ä¿®æ”¹æ–‡ä»¶
- âœ… `errand-front/api/user.js`
  - æ–°å¢ `wechatLogin` æ–¹æ³•ï¼šè°ƒç”¨å¾®ä¿¡ç™»å½•æ¥å£
  - æ–°å¢ `bindWechatPhone` æ–¹æ³•ï¼šç»‘å®šæ‰‹æœºå·
  - ä¿ç•™åŸæœ‰ `login` æ–¹æ³•ä½œä¸ºå…¼å®¹

- âœ… `errand-front/pages/login/login.js`
  - æ–°å¢ `onWechatLogin` æ–¹æ³•ï¼šå®Œæ•´çš„å¾®ä¿¡ç™»å½•æµç¨‹
  - æ–°å¢ `onGetPhoneNumber` æ–¹æ³•ï¼šè·å–æ‰‹æœºå·æˆæƒ
  - ä¿ç•™åŸæœ‰ `onAccountLogin` å’Œ `onRegister` æ–¹æ³•

- âœ… `errand-front/pages/login/login.wxml`
  - æ–°å¢"å¾®ä¿¡ä¸€é”®ç™»å½•"æŒ‰é’®
  - ä¿æŒåŸæœ‰è´¦å·å¯†ç ç™»å½•è¡¨å•

- âœ… `errand-front/pages/login/login.wxss`
  - æ–°å¢å¾®ä¿¡ç™»å½•æŒ‰é’®æ ·å¼
  - ä½¿ç”¨å¾®ä¿¡ç»¿è‰²ä¸»é¢˜è‰² #07C160

### 3. æ–‡æ¡£å’Œå·¥å…·

- âœ… `å¾®ä¿¡ç™»å½•åŠŸèƒ½å®ç°æ–‡æ¡£.md` - å®Œæ•´çš„æŠ€æœ¯æ–‡æ¡£
  - åŠŸèƒ½æ¦‚è¿°å’Œæ ¸å¿ƒç‰¹æ€§
  - è¯¦ç»†çš„é…ç½®æ­¥éª¤
  - API æ¥å£è¯´æ˜
  - å‰ç«¯ä½¿ç”¨ç¤ºä¾‹
  - å®‰å…¨è¯´æ˜
  - æµ‹è¯•æµç¨‹
  - å¸¸è§é—®é¢˜è§£ç­”

- âœ… `WECHAT-LOGIN-README.md` - å¿«é€Ÿå¼€å§‹æŒ‡å—
  - 3æ­¥å¿«é€Ÿé…ç½®
  - æµ‹è¯•æ–¹æ³•
  - å¸¸è§é—®é¢˜

- âœ… `setup-wechat-login.bat` - è‡ªåŠ¨é…ç½®è„šæœ¬
  - æ£€æŸ¥æ•°æ®åº“è¿æ¥
  - æ‰§è¡Œæ•°æ®åº“è¿ç§»
  - é…ç½®å‘å¯¼

- âœ… `test-wechat-login.js` - åŠŸèƒ½æµ‹è¯•è„šæœ¬
  - æµ‹è¯•æ•°æ®åº“å­—æ®µ
  - æµ‹è¯•å¾®ä¿¡ç™»å½•æ¥å£
  - æµ‹è¯•è·å–ç”¨æˆ·ä¿¡æ¯
  - æµ‹è¯•è´¦å·å¯†ç ç™»å½•å…¼å®¹æ€§

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. æ ‡å‡†å¾®ä¿¡ç™»å½•æµç¨‹
```
å‰ç«¯è°ƒç”¨ wx.login() è·å– code
    â†“
å‰ç«¯è°ƒç”¨ wx.getUserProfile() è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
    â†“
å‰ç«¯å‘é€ code å’Œç”¨æˆ·ä¿¡æ¯åˆ°åç«¯
    â†“
åç«¯è°ƒç”¨å¾®ä¿¡ API éªŒè¯ codeï¼Œè·å– openid å’Œ session_key
    â†“
åç«¯æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
    â†“
åç«¯è¿”å› JWT token
    â†“
å‰ç«¯ä¿å­˜ tokenï¼Œå®Œæˆç™»å½•
```

### 2. åŒç™»å½•æ¨¡å¼å¹¶å­˜
- **è´¦å·å¯†ç ç™»å½•**ï¼šåŸæœ‰åŠŸèƒ½å®Œå…¨ä¿ç•™
- **å¾®ä¿¡ä¸€é”®ç™»å½•**ï¼šæ–°å¢åŠŸèƒ½ï¼Œæä¾›æ›´ä¾¿æ·çš„ç™»å½•æ–¹å¼
- ä¸¤ç§æ–¹å¼äº’ä¸å½±å“ï¼Œç”¨æˆ·å¯è‡ªç”±é€‰æ‹©

### 3. æ‰‹æœºå·ç»‘å®šï¼ˆå¯é€‰ï¼‰
- ä½¿ç”¨å¾®ä¿¡å®˜æ–¹ `getPhoneNumber` ç»„ä»¶
- åç«¯è§£å¯†æ‰‹æœºå·å¹¶ç»‘å®šåˆ°ç”¨æˆ·è´¦å·
- æ”¯æŒåç»­æ›´æ–°æ‰‹æœºå·

### 4. å®‰å…¨æ€§ä¿éšœ
- session_key å­˜å‚¨åœ¨æ•°æ®åº“ï¼Œä¸è¿”å›å‰ç«¯
- ä½¿ç”¨ AES-128-CBC è§£å¯†æ•æ„Ÿæ•°æ®
- éªŒè¯ watermark.appid é˜²æ­¢æ•°æ®ç¯¡æ”¹
- æ”¯æŒ unionid è·¨åº”ç”¨è¯†åˆ«ç”¨æˆ·

## ğŸ“Š æ•°æ®åº“å˜æ›´

### æ–°å¢å­—æ®µ
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| openid | VARCHAR(100) | å¾®ä¿¡ openidï¼Œå”¯ä¸€ç´¢å¼• |
| unionid | VARCHAR(100) | å¾®ä¿¡ unionidï¼Œå”¯ä¸€ç´¢å¼• |
| session_key | VARCHAR(100) | å¾®ä¿¡ session_key |
| nickname | VARCHAR(100) | ç”¨æˆ·æ˜µç§° |
| gender | TINYINT | æ€§åˆ« |
| school | VARCHAR(100) | å­¦æ ¡ |
| bio | TEXT | ä¸ªäººç®€ä»‹ |

### å­—æ®µä¿®æ”¹
- `password` æ”¹ä¸ºå¯ç©ºï¼ˆå¾®ä¿¡ç™»å½•ç”¨æˆ·å¯èƒ½æ²¡æœ‰å¯†ç ï¼‰
- `email` æ”¹ä¸ºå¯ç©º

## ğŸ”Œ API æ¥å£

### 1. å¾®ä¿¡ç™»å½•
```
POST /api/auth/wechat/login

è¯·æ±‚ï¼š
{
  "code": "å¾®ä¿¡ç™»å½•å‡­è¯",
  "nickname": "ç”¨æˆ·æ˜µç§°ï¼ˆå¯é€‰ï¼‰",
  "avatar": "ç”¨æˆ·å¤´åƒURLï¼ˆå¯é€‰ï¼‰"
}

å“åº”ï¼š
{
  "success": true,
  "code": 0,
  "token": "jwt_token",
  "user": {
    "id": 1,
    "username": "wx_1703856000000",
    "nickname": "å¾®ä¿¡ç”¨æˆ·",
    "avatar": "https://...",
    "phone": null,
    "openid": "oxxxxxx"
  },
  "message": "ç™»å½•æˆåŠŸ"
}
```

### 2. ç»‘å®šæ‰‹æœºå·
```
POST /api/auth/wechat/bind-phone
Authorization: Bearer {token}

è¯·æ±‚ï¼š
{
  "encryptedData": "åŠ å¯†æ•°æ®",
  "iv": "åŠ å¯†ç®—æ³•çš„åˆå§‹å‘é‡"
}

å“åº”ï¼š
{
  "success": true,
  "code": 0,
  "data": {
    "phone": "13800138000"
  },
  "message": "æ‰‹æœºå·ç»‘å®šæˆåŠŸ"
}
```

## ğŸš€ ä½¿ç”¨æ­¥éª¤

### é…ç½®æ­¥éª¤

1. **æ‰§è¡Œæ•°æ®åº“è¿ç§»**
   ```bash
   cd errand-back
   mysql -u errand_user -p -D errand_platform < database/migrations/add_wechat_fields.sql
   ```

2. **é…ç½®å¾®ä¿¡ä¿¡æ¯**
   ç¼–è¾‘ `errand-back/.env`ï¼š
   ```env
   WECHAT_APPID=ä½ çš„AppID
   WECHAT_SECRET=ä½ çš„AppSecret
   ```

3. **é‡å¯åç«¯æœåŠ¡**
   ```bash
   npm start
   ```

4. **æµ‹è¯•åŠŸèƒ½**
   ```bash
   node test-wechat-login.js
   ```

### å‰ç«¯ä½¿ç”¨

ç”¨æˆ·åœ¨ç™»å½•é¡µé¢å¯ä»¥çœ‹åˆ°ï¼š
- è´¦å·å¯†ç ç™»å½•è¡¨å•
- "å¾®ä¿¡ä¸€é”®ç™»å½•"æŒ‰é’®
- "ä½¿ç”¨æµ‹è¯•è´¦å·ç™»å½•"æŒ‰é’®

ç‚¹å‡»"å¾®ä¿¡ä¸€é”®ç™»å½•"å³å¯å®Œæˆå¾®ä¿¡ç™»å½•ã€‚

## âœ¨ æŠ€æœ¯äº®ç‚¹

1. **æ ‡å‡†å®ç°**ï¼šå®Œå…¨éµå¾ªå¾®ä¿¡å®˜æ–¹æ–‡æ¡£çš„æœ€ä½³å®è·µ
2. **å®‰å…¨å¯é **ï¼šsession_key å®‰å…¨å­˜å‚¨ï¼Œæ•°æ®åŠ å¯†ä¼ è¾“
3. **å‘åå…¼å®¹**ï¼šä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼Œå¹³æ»‘å‡çº§
4. **ç”¨æˆ·å‹å¥½**ï¼šä¸€é”®ç™»å½•ï¼Œæ— éœ€è®°å¿†å¯†ç 
5. **æ‰©å±•æ€§å¼º**ï¼šæ”¯æŒ unionidï¼Œå¯è·¨åº”ç”¨è¯†åˆ«ç”¨æˆ·
6. **å®Œå–„æ–‡æ¡£**ï¼šæä¾›è¯¦ç»†çš„é…ç½®å’Œä½¿ç”¨æ–‡æ¡£

## ğŸ“ æ³¨æ„äº‹é¡¹

### å¼€å‘ç¯å¢ƒ
- å¯ä»¥åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­æµ‹è¯•
- éœ€è¦é…ç½®åˆæ³•åŸŸåï¼ˆå¼€å‘æ—¶å¯å‹¾é€‰"ä¸æ ¡éªŒåˆæ³•åŸŸå"ï¼‰

### ç”Ÿäº§ç¯å¢ƒ
- **å¿…é¡»ä½¿ç”¨ HTTPS**
- åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½®æœåŠ¡å™¨åŸŸå
- ä¸è¦å°† `.env` æ–‡ä»¶æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
- å®šæœŸæ›´æ–° AppSecret

### å¾®ä¿¡é…ç½®
1. ç™»å½• [å¾®ä¿¡å…¬ä¼—å¹³å°](https://mp.weixin.qq.com/)
2. é…ç½®æœåŠ¡å™¨åŸŸåï¼ˆå¼€å‘ â†’ å¼€å‘ç®¡ç† â†’ å¼€å‘è®¾ç½® â†’ æœåŠ¡å™¨åŸŸåï¼‰
3. æ·»åŠ  request åˆæ³•åŸŸåï¼š`https://your-domain.com`

## ğŸ‰ æ€»ç»“

å¾®ä¿¡ç™»å½•åŠŸèƒ½å·²å®Œæ•´å®ç°å¹¶é›†æˆåˆ°é¡¹ç›®ä¸­ï¼Œä¸»è¦æˆæœï¼š

âœ… **åç«¯**ï¼šå®Œæ•´çš„å¾®ä¿¡ç™»å½•æœåŠ¡ï¼ŒåŒ…æ‹¬ code éªŒè¯ã€ç”¨æˆ·ç®¡ç†ã€æ‰‹æœºå·è§£å¯†  
âœ… **å‰ç«¯**ï¼šå‹å¥½çš„ç™»å½•ç•Œé¢ï¼Œæ”¯æŒå¾®ä¿¡ä¸€é”®ç™»å½•å’Œæ‰‹æœºå·ç»‘å®š  
âœ… **æ•°æ®åº“**ï¼šæ–°å¢å¾®ä¿¡ç›¸å…³å­—æ®µï¼Œæ”¯æŒå¾®ä¿¡ç”¨æˆ·æ•°æ®å­˜å‚¨  
âœ… **æ–‡æ¡£**ï¼šè¯¦ç»†çš„æŠ€æœ¯æ–‡æ¡£å’Œå¿«é€Ÿå¼€å§‹æŒ‡å—  
âœ… **å·¥å…·**ï¼šè‡ªåŠ¨é…ç½®è„šæœ¬å’ŒåŠŸèƒ½æµ‹è¯•è„šæœ¬  
âœ… **å…¼å®¹æ€§**ï¼šä¸åŸæœ‰ç™»å½•æ–¹å¼å®Œç¾å…±å­˜ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½  

ç”¨æˆ·ç°åœ¨å¯ä»¥é€‰æ‹©ä½¿ç”¨è´¦å·å¯†ç ç™»å½•æˆ–å¾®ä¿¡ä¸€é”®ç™»å½•ï¼Œäº«å—æ›´ä¾¿æ·çš„ç™»å½•ä½“éªŒï¼

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¾®ä¿¡ç™»å½•åŠŸèƒ½å®ç°æ–‡æ¡£.md](./å¾®ä¿¡ç™»å½•åŠŸèƒ½å®ç°æ–‡æ¡£.md) - å®Œæ•´æŠ€æœ¯æ–‡æ¡£
- [WECHAT-LOGIN-README.md](./WECHAT-LOGIN-README.md) - å¿«é€Ÿå¼€å§‹æŒ‡å—
- [å¾®ä¿¡å®˜æ–¹æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html)

## ğŸ”— å¿«é€Ÿé“¾æ¥

- é…ç½®è„šæœ¬ï¼š`setup-wechat-login.bat`
- æµ‹è¯•è„šæœ¬ï¼š`test-wechat-login.js`
- æ•°æ®åº“è¿ç§»ï¼š`errand-back/database/migrations/add_wechat_fields.sql`
- å¾®ä¿¡æœåŠ¡ï¼š`errand-back/src/services/wechat.service.js`
