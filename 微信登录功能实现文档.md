# 微信登录功能实现文档

## 📋 功能概述

本项目已成功集成微信小程序登录功能，与原有的账号密码登录方式并存，用户可以选择任意方式登录。

## 🎯 核心特性

### 1. 双登录模式
- ✅ **账号密码登录**：传统的用户名/密码登录方式
- ✅ **微信一键登录**：使用微信授权快速登录

### 2. 微信登录流程
```
用户点击"微信一键登录"
    ↓
调用 wx.login() 获取临时登录凭证 code
    ↓
（可选）调用 wx.getUserProfile() 获取用户头像昵称
    ↓
将 code 和用户信息发送到后端
    ↓
后端调用微信服务器验证 code，获取 openid 和 session_key
    ↓
查找或创建用户账号
    ↓
返回 JWT token 和用户信息
    ↓
前端保存登录状态，跳转首页
```

### 3. 手机号绑定（可选）
- 用户可以通过微信授权获取手机号
- 使用 `<button open-type="getPhoneNumber">` 组件
- 后端解密手机号并绑定到用户账号

## 📁 文件结构

### 后端文件
```
errand-back/
├── src/
│   ├── controllers/
│   │   └── auth.controller.js          # 新增微信登录相关方法
│   ├── routes/
│   │   └── auth.routes.js              # 新增微信登录路由
│   ├── models/
│   │   └── User.js                     # 新增微信用户相关方法
│   └── services/
│       └── wechat.service.js           # 微信服务（新建）
├── database/
│   └── migrations/
│       └── add_wechat_fields.sql       # 数据库迁移脚本（新建）
└── .env                                # 新增微信配置项
```

### 前端文件
```
errand-front/
├── pages/
│   └── login/
│       ├── login.js                    # 新增微信登录方法
│       ├── login.wxml                  # 新增微信登录按钮
│       └── login.wxss                  # 新增微信登录样式
└── api/
    └── user.js                         # 新增微信登录 API
```

## 🔧 配置步骤

### 1. 数据库配置

执行数据库迁移脚本：

```bash
cd errand-back
mysql -u errand_user -p errand_platform < database/migrations/add_wechat_fields.sql
```

或者手动执行 SQL：

```sql
-- 添加微信相关字段
ALTER TABLE users 
ADD COLUMN openid VARCHAR(100) UNIQUE COMMENT '微信 openid',
ADD COLUMN unionid VARCHAR(100) UNIQUE COMMENT '微信 unionid',
ADD COLUMN session_key VARCHAR(100) COMMENT '微信 session_key',
ADD COLUMN nickname VARCHAR(100) COMMENT '用户昵称',
ADD COLUMN gender TINYINT DEFAULT 0 COMMENT '性别：0-未知，1-男，2-女',
ADD COLUMN school VARCHAR(100) COMMENT '学校',
ADD COLUMN bio TEXT COMMENT '个人简介';

-- 创建索引
CREATE INDEX idx_openid ON users(openid);
CREATE INDEX idx_unionid ON users(unionid);

-- 修改字段允许为空
ALTER TABLE users MODIFY COLUMN password VARCHAR(255) NULL;
ALTER TABLE users MODIFY COLUMN email VARCHAR(100) NULL;
```

### 2. 后端环境变量配置

编辑 `errand-back/.env` 文件，添加微信小程序配置：

```env
# WeChat Mini Program
WECHAT_APPID=your_wechat_appid
WECHAT_SECRET=your_wechat_secret
```

**获取方式：**
1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入"开发" -> "开发管理" -> "开发设置"
3. 复制 AppID 和 AppSecret

### 3. 安装依赖

后端需要安装 axios（如果还没有）：

```bash
cd errand-back
npm install axios
```

### 4. 前端配置

在微信开发者工具中：
1. 配置服务器域名（开发 -> 开发管理 -> 服务器域名）
2. 添加 request 合法域名：你的后端服务器域址
3. 添加 uploadFile 合法域名（如果需要上传头像）

## 📡 API 接口

### 1. 微信登录
```
POST /api/auth/wechat/login
```

**请求参数：**
```json
{
  "code": "微信登录凭证",
  "nickname": "用户昵称（可选）",
  "avatar": "用户头像URL（可选）"
}
```

**响应示例：**
```json
{
  "success": true,
  "code": 0,
  "token": "jwt_token_here",
  "user": {
    "id": 1,
    "username": "wx_1703856000000",
    "nickname": "微信用户",
    "avatar": "https://...",
    "phone": null,
    "openid": "oxxxxxxxxxxxxxx"
  },
  "message": "登录成功"
}
```

### 2. 绑定手机号
```
POST /api/auth/wechat/bind-phone
Authorization: Bearer {token}
```

**请求参数：**
```json
{
  "encryptedData": "加密数据",
  "iv": "加密算法的初始向量"
}
```

**响应示例：**
```json
{
  "success": true,
  "code": 0,
  "data": {
    "phone": "13800138000"
  },
  "message": "手机号绑定成功"
}
```

## 💻 前端使用示例

### 1. 微信一键登录

```javascript
// pages/login/login.js
async onWechatLogin() {
  try {
    wx.showLoading({ title: '登录中...', mask: true });

    // 1. 获取微信登录 code
    const loginRes = await wx.login();
    
    // 2. 获取用户信息（可选）
    let userInfo = null;
    try {
      const profileRes = await wx.getUserProfile({
        desc: '用于完善用户资料'
      });
      userInfo = profileRes.userInfo;
    } catch (error) {
      console.log('用户取消授权');
    }

    // 3. 调用后端登录接口
    const result = await userAPI.wechatLogin(loginRes.code, userInfo);
    
    // 4. 保存登录信息
    authUtil.saveLoginInfo(result.token, result.user);
    
    wx.hideLoading();
    wx.showToast({ title: '登录成功', icon: 'success' });
    
    // 5. 跳转首页
    setTimeout(() => {
      wx.switchTab({ url: '/pages/index/index' });
    }, 1500);
    
  } catch (error) {
    wx.hideLoading();
    wx.showToast({ title: error.message || '登录失败', icon: 'none' });
  }
}
```

### 2. 获取手机号

```xml
<!-- WXML -->
<button open-type="getPhoneNumber" bindgetphonenumber="onGetPhoneNumber">
  获取手机号
</button>
```

```javascript
// JS
async onGetPhoneNumber(e) {
  if (e.detail.errMsg !== 'getPhoneNumber:ok') {
    wx.showToast({ title: '获取手机号失败', icon: 'none' });
    return;
  }

  try {
    const result = await userAPI.bindWechatPhone(
      e.detail.encryptedData,
      e.detail.iv
    );
    
    wx.showToast({ title: '手机号绑定成功', icon: 'success' });
    
    // 更新本地用户信息
    const userInfo = authUtil.getUserInfo();
    userInfo.phone = result.data.phone;
    authUtil.saveLoginInfo(authUtil.getToken(), userInfo);
    
  } catch (error) {
    wx.showToast({ title: error.message || '绑定失败', icon: 'none' });
  }
}
```

## 🔐 安全说明

### 1. session_key 管理
- session_key 存储在数据库中，用于解密敏感数据
- 每次用户重新登录时更新 session_key
- 不要将 session_key 返回给前端

### 2. openid 和 unionid
- **openid**：用户在当前小程序的唯一标识
- **unionid**：用户在同一开放平台账号下的唯一标识
- 优先使用 unionid 查找用户（如果有）

### 3. 数据加密
- 手机号等敏感数据使用 AES-128-CBC 加密
- 需要 session_key 才能解密
- 验证 watermark.appid 防止数据被篡改

## 🧪 测试流程

### 1. 测试微信登录

1. 在微信开发者工具中打开小程序
2. 点击"微信一键登录"按钮
3. 授权获取用户信息（可选）
4. 检查是否成功登录并跳转首页
5. 查看数据库 users 表，确认创建了新用户

### 2. 测试手机号绑定

1. 登录后进入个人中心
2. 点击"绑定手机号"按钮
3. 授权获取手机号
4. 检查是否绑定成功
5. 查看数据库确认 phone 字段已更新

### 3. 测试账号密码登录

1. 使用原有的账号密码登录
2. 确认不影响原有功能
3. 两种登录方式可以正常切换

## 📊 数据库表结构

### users 表新增字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| openid | VARCHAR(100) | 微信 openid，唯一索引 |
| unionid | VARCHAR(100) | 微信 unionid，唯一索引 |
| session_key | VARCHAR(100) | 微信 session_key |
| nickname | VARCHAR(100) | 用户昵称 |
| gender | TINYINT | 性别：0-未知，1-男，2-女 |
| school | VARCHAR(100) | 学校 |
| bio | TEXT | 个人简介 |

### 字段修改

- `password` 字段改为可空（微信登录用户可能没有密码）
- `email` 字段改为可空

## 🚀 部署注意事项

### 1. 生产环境配置

- 确保 `.env` 文件中的 `WECHAT_APPID` 和 `WECHAT_SECRET` 正确
- 不要将 `.env` 文件提交到版本控制系统
- 使用环境变量或密钥管理服务存储敏感信息

### 2. 服务器域名配置

在微信公众平台配置以下域名：
- request 合法域名：`https://your-domain.com`
- uploadFile 合法域名：`https://your-domain.com`
- downloadFile 合法域名：`https://your-domain.com`

### 3. HTTPS 要求

- 微信小程序要求后端必须使用 HTTPS
- 配置 SSL 证书
- 确保证书有效且未过期

## 🔄 兼容性说明

### 向后兼容

- ✅ 原有的账号密码登录功能完全保留
- ✅ 现有用户数据不受影响
- ✅ 可以为现有账号绑定微信 openid

### 用户账号关联

如果需要将微信账号与现有账号关联：

```javascript
// 后端实现示例
async linkWechatAccount(userId, openid, unionid) {
  // 检查 openid 是否已被其他账号使用
  const existingUser = await User.findByOpenid(openid);
  if (existingUser && existingUser.id !== userId) {
    throw new Error('该微信账号已绑定其他用户');
  }
  
  // 绑定微信账号
  await User.updateWechatInfo(userId, { openid, unionid });
}
```

## 📝 常见问题

### Q1: 获取不到 unionid？
A: unionid 需要满足以下条件之一：
- 小程序绑定到微信开放平台
- 用户关注了同主体的公众号
- 用户在同主体的其他小程序登录过

### Q2: code 已被使用？
A: 每个 code 只能使用一次，5分钟内有效。不要重复使用同一个 code。

### Q3: 解密手机号失败？
A: 检查以下几点：
- session_key 是否是最新的
- encryptedData 和 iv 是否正确
- 用户是否重新登录导致 session_key 失效

### Q4: 如何处理用户拒绝授权？
A: 用户拒绝授权时，可以：
- 使用默认头像和昵称
- 引导用户使用账号密码登录
- 在需要时再次请求授权

## 🎉 总结

微信登录功能已成功集成到项目中，主要特点：

1. ✅ 标准的微信小程序登录流程
2. ✅ 与原有登录方式并存
3. ✅ 支持手机号绑定
4. ✅ 安全的数据加密
5. ✅ 完善的错误处理
6. ✅ 良好的用户体验

用户现在可以选择使用账号密码登录或微信一键登录，两种方式互不影响，提供了更灵活的登录选择。
