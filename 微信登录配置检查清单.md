# å¾®ä¿¡ç™»å½•é…ç½®æ£€æŸ¥æ¸…å• âœ…

ä½¿ç”¨æ­¤æ¸…å•ç¡®ä¿å¾®ä¿¡ç™»å½•åŠŸèƒ½æ­£ç¡®é…ç½®ã€‚

## ğŸ“‹ é…ç½®å‰å‡†å¤‡

- [ ] å·²æœ‰å¾®ä¿¡å°ç¨‹åºè´¦å·
- [ ] å·²è·å– AppID å’Œ AppSecret
- [ ] åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸

## ğŸ”§ åç«¯é…ç½®

### 1. æ•°æ®åº“è¿ç§»
- [ ] æ‰§è¡Œäº† `add_wechat_fields.sql` è„šæœ¬
- [ ] ç¡®è®¤ users è¡¨æ–°å¢äº†ä»¥ä¸‹å­—æ®µï¼š
  - [ ] openid
  - [ ] unionid
  - [ ] session_key
  - [ ] nickname
  - [ ] gender
  - [ ] school
  - [ ] bio
- [ ] ç¡®è®¤åˆ›å»ºäº†ç´¢å¼•ï¼š
  - [ ] idx_openid
  - [ ] idx_unionid

**æ‰§è¡Œå‘½ä»¤ï¼š**
```bash
cd errand-back
mysql -u errand_user -p -D errand_platform < database/migrations/add_wechat_fields.sql
```

### 2. ç¯å¢ƒå˜é‡é…ç½®
- [ ] ç¼–è¾‘äº† `errand-back/.env` æ–‡ä»¶
- [ ] æ·»åŠ äº† `WECHAT_APPID=ä½ çš„AppID`
- [ ] æ·»åŠ äº† `WECHAT_SECRET=ä½ çš„AppSecret`
- [ ] ç¡®è®¤ AppID å’Œ AppSecret æ­£ç¡®æ— è¯¯

**ç¤ºä¾‹ï¼š**
```env
WECHAT_APPID=wx1234567890abcdef
WECHAT_SECRET=abcdef1234567890abcdef1234567890
```

### 3. ä¾èµ–æ£€æŸ¥
- [ ] ç¡®è®¤ axios å·²å®‰è£…ï¼ˆæŸ¥çœ‹ package.jsonï¼‰
- [ ] å¦‚æœªå®‰è£…ï¼Œè¿è¡Œ `npm install axios`

### 4. æ–‡ä»¶æ£€æŸ¥
- [ ] `src/services/wechat.service.js` æ–‡ä»¶å­˜åœ¨
- [ ] `src/controllers/auth.controller.js` å·²æ›´æ–°
- [ ] `src/routes/auth.routes.js` å·²æ›´æ–°
- [ ] `src/models/User.js` å·²æ›´æ–°

### 5. é‡å¯æœåŠ¡
- [ ] é‡å¯äº†åç«¯æœåŠ¡
- [ ] ç¡®è®¤æœåŠ¡å¯åŠ¨æ— é”™è¯¯
- [ ] ç¡®è®¤ç«¯å£ 3000 å¯è®¿é—®

**é‡å¯å‘½ä»¤ï¼š**
```bash
cd errand-back
npm start
```

## ğŸ“± å‰ç«¯é…ç½®

### 1. æ–‡ä»¶æ£€æŸ¥
- [ ] `api/user.js` å·²æ›´æ–°ï¼ˆæ–°å¢ wechatLogin æ–¹æ³•ï¼‰
- [ ] `pages/login/login.js` å·²æ›´æ–°ï¼ˆæ–°å¢ onWechatLogin æ–¹æ³•ï¼‰
- [ ] `pages/login/login.wxml` å·²æ›´æ–°ï¼ˆæ–°å¢å¾®ä¿¡ç™»å½•æŒ‰é’®ï¼‰
- [ ] `pages/login/login.wxss` å·²æ›´æ–°ï¼ˆæ–°å¢æŒ‰é’®æ ·å¼ï¼‰

### 2. å¾®ä¿¡å¼€å‘è€…å·¥å…·é…ç½®
- [ ] æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·
- [ ] å¯¼å…¥é¡¹ç›®ï¼ˆerrand-front ç›®å½•ï¼‰
- [ ] å¡«å†™æ­£ç¡®çš„ AppID
- [ ] å‹¾é€‰"ä¸æ ¡éªŒåˆæ³•åŸŸå"ï¼ˆå¼€å‘é˜¶æ®µï¼‰

### 3. ç½‘ç»œé…ç½®ï¼ˆå¼€å‘é˜¶æ®µï¼‰
- [ ] åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­å‹¾é€‰"ä¸æ ¡éªŒåˆæ³•åŸŸåã€web-viewï¼ˆä¸šåŠ¡åŸŸåï¼‰ã€TLS ç‰ˆæœ¬ä»¥åŠ HTTPS è¯ä¹¦"
- [ ] ç¡®è®¤åç«¯æœåŠ¡åœ°å€æ­£ç¡®ï¼ˆé€šå¸¸æ˜¯ http://localhost:3000ï¼‰

## ğŸ§ª åŠŸèƒ½æµ‹è¯•

### 1. è¿è¡Œè‡ªåŠ¨æµ‹è¯•
- [ ] è¿è¡Œ `node test-wechat-login.js`
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡

**æµ‹è¯•é¡¹ç›®ï¼š**
- [ ] æ•°æ®åº“å­—æ®µæ£€æŸ¥é€šè¿‡
- [ ] å¾®ä¿¡ç™»å½•æ¥å£æµ‹è¯•é€šè¿‡
- [ ] è·å–ç”¨æˆ·ä¿¡æ¯æµ‹è¯•é€šè¿‡
- [ ] è´¦å·å¯†ç ç™»å½•å…¼å®¹æ€§æµ‹è¯•é€šè¿‡

### 2. æ‰‹åŠ¨æµ‹è¯• - å¾®ä¿¡ç™»å½•
- [ ] åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­æ‰“å¼€ç™»å½•é¡µé¢
- [ ] ç‚¹å‡»"å¾®ä¿¡ä¸€é”®ç™»å½•"æŒ‰é’®
- [ ] æˆæƒè·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚æœå¼¹å‡ºæˆæƒæ¡†ï¼‰
- [ ] æˆåŠŸç™»å½•å¹¶è·³è½¬åˆ°é¦–é¡µ
- [ ] æŸ¥çœ‹æ•°æ®åº“ï¼Œç¡®è®¤åˆ›å»ºäº†æ–°ç”¨æˆ·è®°å½•

### 3. æ‰‹åŠ¨æµ‹è¯• - è´¦å·å¯†ç ç™»å½•
- [ ] ä½¿ç”¨æµ‹è¯•è´¦å·ç™»å½•ï¼ˆstudent1 / admin123ï¼‰
- [ ] ç¡®è®¤ç™»å½•æˆåŠŸ
- [ ] ç¡®è®¤åŸæœ‰åŠŸèƒ½ä¸å—å½±å“

### 4. æ‰‹åŠ¨æµ‹è¯• - æ‰‹æœºå·ç»‘å®šï¼ˆå¯é€‰ï¼‰
- [ ] ç™»å½•åè¿›å…¥ä¸ªäººä¸­å¿ƒ
- [ ] ç‚¹å‡»"ç»‘å®šæ‰‹æœºå·"æŒ‰é’®
- [ ] æˆæƒè·å–æ‰‹æœºå·
- [ ] ç¡®è®¤ç»‘å®šæˆåŠŸ
- [ ] æŸ¥çœ‹æ•°æ®åº“ï¼Œç¡®è®¤ phone å­—æ®µå·²æ›´æ–°

## ğŸŒ ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼ˆéƒ¨ç½²æ—¶ï¼‰

### 1. HTTPS é…ç½®
- [ ] æœåŠ¡å™¨å·²é…ç½® SSL è¯ä¹¦
- [ ] åç«¯æœåŠ¡ä½¿ç”¨ HTTPS
- [ ] è¯ä¹¦æœ‰æ•ˆä¸”æœªè¿‡æœŸ

### 2. å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½®
- [ ] ç™»å½• [å¾®ä¿¡å…¬ä¼—å¹³å°](https://mp.weixin.qq.com/)
- [ ] è¿›å…¥"å¼€å‘" â†’ "å¼€å‘ç®¡ç†" â†’ "å¼€å‘è®¾ç½®"
- [ ] é…ç½®æœåŠ¡å™¨åŸŸåï¼š
  - [ ] request åˆæ³•åŸŸåï¼š`https://your-domain.com`
  - [ ] uploadFile åˆæ³•åŸŸåï¼š`https://your-domain.com`
  - [ ] downloadFile åˆæ³•åŸŸåï¼š`https://your-domain.com`

### 3. å®‰å…¨é…ç½®
- [ ] `.env` æ–‡ä»¶æœªæäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
- [ ] `.gitignore` åŒ…å« `.env`
- [ ] ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†æœåŠ¡
- [ ] AppSecret å®šæœŸæ›´æ–°

### 4. å‰ç«¯é…ç½®
- [ ] å–æ¶ˆå‹¾é€‰"ä¸æ ¡éªŒåˆæ³•åŸŸå"
- [ ] ç¡®è®¤æ‰€æœ‰ API è¯·æ±‚ä½¿ç”¨ HTTPS
- [ ] ä¸Šä¼ ä»£ç åˆ°å¾®ä¿¡åå°å®¡æ ¸

## ğŸ“Š éªŒè¯ç»“æœ

### æ•°æ®åº“éªŒè¯
```sql
-- æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨
SHOW COLUMNS FROM users WHERE Field IN ('openid', 'unionid', 'session_key', 'nickname');

-- æ£€æŸ¥ç´¢å¼•æ˜¯å¦åˆ›å»º
SHOW INDEX FROM users WHERE Key_name IN ('idx_openid', 'idx_unionid');

-- æŸ¥çœ‹å¾®ä¿¡ç™»å½•çš„ç”¨æˆ·
SELECT id, username, nickname, openid, phone, created_at 
FROM users 
WHERE openid IS NOT NULL 
ORDER BY created_at DESC 
LIMIT 5;
```

### API éªŒè¯
```bash
# æµ‹è¯•å¾®ä¿¡ç™»å½•æ¥å£
curl -X POST http://localhost:3000/api/auth/wechat/login \
  -H "Content-Type: application/json" \
  -d '{"code":"test_code","nickname":"æµ‹è¯•ç”¨æˆ·","avatar":""}'

# æµ‹è¯•è·å–ç”¨æˆ·ä¿¡æ¯
curl -X GET http://localhost:3000/api/auth/me \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## âš ï¸ å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: æç¤º"å¾®ä¿¡æ¥å£é”™è¯¯"
- [ ] æ£€æŸ¥ WECHAT_APPID æ˜¯å¦æ­£ç¡®
- [ ] æ£€æŸ¥ WECHAT_SECRET æ˜¯å¦æ­£ç¡®
- [ ] æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
- [ ] æ£€æŸ¥å¾®ä¿¡æœåŠ¡å™¨æ˜¯å¦å¯è®¿é—®

### é—®é¢˜ 2: code å·²è¢«ä½¿ç”¨
- [ ] ç¡®è®¤æ²¡æœ‰é‡å¤ä½¿ç”¨åŒä¸€ä¸ª code
- [ ] æ¯æ¬¡ç™»å½•éƒ½è¦é‡æ–°è°ƒç”¨ wx.login()

### é—®é¢˜ 3: æ•°æ®åº“é”™è¯¯
- [ ] æ£€æŸ¥æ•°æ®åº“è¿ç§»æ˜¯å¦æˆåŠŸæ‰§è¡Œ
- [ ] æ£€æŸ¥å­—æ®µæ˜¯å¦éƒ½å·²åˆ›å»º
- [ ] æ£€æŸ¥æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸

### é—®é¢˜ 4: å‰ç«¯æ— æ³•è°ƒç”¨æ¥å£
- [ ] æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨
- [ ] æ£€æŸ¥ API åœ°å€æ˜¯å¦æ­£ç¡®
- [ ] æ£€æŸ¥æ˜¯å¦å‹¾é€‰"ä¸æ ¡éªŒåˆæ³•åŸŸå"ï¼ˆå¼€å‘é˜¶æ®µï¼‰

### é—®é¢˜ 5: è·å–ä¸åˆ° unionid
- [ ] è¿™æ˜¯æ­£å¸¸çš„ï¼Œunionid éœ€è¦ç‰¹å®šæ¡ä»¶
- [ ] ä¸å½±å“ç™»å½•åŠŸèƒ½
- [ ] å¯ä»¥åªä½¿ç”¨ openid

## âœ… é…ç½®å®Œæˆç¡®è®¤

å…¨éƒ¨å®Œæˆåï¼Œç¡®è®¤ä»¥ä¸‹åŠŸèƒ½æ­£å¸¸ï¼š

- [ ] âœ… å¾®ä¿¡ä¸€é”®ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] âœ… è´¦å·å¯†ç ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] âœ… ä¸¤ç§ç™»å½•æ–¹å¼å¯ä»¥åˆ‡æ¢
- [ ] âœ… ç”¨æˆ·ä¿¡æ¯æ­£ç¡®ä¿å­˜
- [ ] âœ… Token æ­£å¸¸ç”Ÿæˆå’ŒéªŒè¯
- [ ] âœ… æ‰‹æœºå·ç»‘å®šåŠŸèƒ½æ­£å¸¸ï¼ˆå¦‚æœéœ€è¦ï¼‰

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¾®ä¿¡ç™»å½•åŠŸèƒ½å®ç°æ–‡æ¡£.md](./å¾®ä¿¡ç™»å½•åŠŸèƒ½å®ç°æ–‡æ¡£.md) - å®Œæ•´æŠ€æœ¯æ–‡æ¡£
- [WECHAT-LOGIN-README.md](./WECHAT-LOGIN-README.md) - å¿«é€Ÿå¼€å§‹æŒ‡å—
- [å¾®ä¿¡ç™»å½•åŠŸèƒ½å®ç°æ€»ç»“.md](./å¾®ä¿¡ç™»å½•åŠŸèƒ½å®ç°æ€»ç»“.md) - å®ç°æ€»ç»“

## ğŸ‰ æ­å–œï¼

å¦‚æœæ‰€æœ‰é¡¹ç›®éƒ½å·²å‹¾é€‰ï¼Œè¯´æ˜å¾®ä¿¡ç™»å½•åŠŸèƒ½å·²æˆåŠŸé…ç½®ï¼

ç°åœ¨ç”¨æˆ·å¯ä»¥ä½¿ç”¨å¾®ä¿¡ä¸€é”®ç™»å½•ï¼Œäº«å—æ›´ä¾¿æ·çš„ç™»å½•ä½“éªŒäº†ï¼ğŸŠ
