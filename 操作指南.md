# 取消协商功能 - 操作指南

## ✅ 当前状态

- ✅ 数据库表已创建
- ✅ 后端服务正在运行（端口3000）
- ✅ 测试用户已创建（test1, test2）
- ✅ 功能测试全部通过

## 🎮 如何使用

### 场景1：接单者想要取消订单

1. **打开订单详情页面**
   - 确保订单状态为"已接单"（accepted）
   - 你是接单者

2. **发起取消请求**
   - 点击黄色的"请求取消"按钮
   - 输入取消原因（例如：临时有事）
   - 点击确认

3. **等待发布者处理**
   - 页面会显示橙色的取消请求卡片
   - 显示"等待发布者处理..."

4. **可选：聊天协商**
   - 点击紫色的"💬 聊天协商"按钮
   - 与发布者沟通取消原因

### 场景2：发布者处理取消请求

1. **收到通知**
   - 系统会发送通知
   - 聊天界面会收到系统消息

2. **查看订单详情**
   - 打开订单详情页面
   - 看到橙色的取消请求卡片

3. **查看请求信息**
   - 查看接单者的取消原因
   - 评估是否同意

4. **处理请求**
   - 点击绿色的"同意取消"按钮 → 订单取消
   - 或点击灰色的"拒绝"按钮 → 订单继续

### 场景3：双方协商沟通

1. **进入聊天**
   - 在订单详情页面点击"💬 聊天协商"
   - 进入聊天界面

2. **发送消息**
   - 讨论订单相关事宜
   - 达成一致

3. **处理请求**
   - 返回订单详情
   - 发布者做出决定

## 🎨 界面说明

### 按钮颜色含义

| 颜色 | 按钮 | 说明 |
|------|------|------|
| 🔵 蓝色 | 接单 | pending状态，非发布者可见 |
| 🟣 紫色 | 💬 聊天协商 | accepted状态，双方可见 |
| 🟢 绿色 | 完成订单 | accepted状态，接单者可见 |
| 🟡 黄色 | 请求取消 | accepted状态，接单者可见 |
| 🔴 红色 | 取消订单 | pending状态，双方可见 |

### 取消请求卡片

```
┌─────────────────────────────┐
│ ⚠️ 取消请求                  │
├─────────────────────────────┤
│ 接单者请求取消订单           │
│ 原因：临时有事，无法完成订单 │
│                             │
│ [同意取消] [拒绝]           │  ← 发布者看到
│ 或                          │
│ 等待发布者处理...           │  ← 接单者看到
└─────────────────────────────┘
```

## 🧪 测试账号

```
用户1（发布者）：
- 用户名：test1
- 密码：password123

用户2（接单者）：
- 用户名：test2
- 密码：password123
```

## 📱 测试流程

1. **用test1登录** → 发布订单
2. **用test2登录** → 接单
3. **用test2** → 请求取消
4. **用test1** → 同意/拒绝

## 🔍 状态说明

| 订单状态 | 说明 | 可用操作 |
|---------|------|---------|
| pending | 待接单 | 接单、直接取消 |
| accepted | 已接单 | 完成、请求取消、聊天 |
| completed | 已完成 | 无 |
| cancelled | 已取消 | 无 |

## ❓ 常见问题

**Q: 为什么看不到"请求取消"按钮？**  
A: 检查：1) 订单是否为accepted状态 2) 你是否是接单者 3) 是否已有待处理的请求

**Q: 为什么无法发起取消请求？**  
A: 同一订单只能有一个待处理的取消请求，等待当前请求被处理后才能发起新请求

**Q: 聊天按钮不显示？**  
A: 聊天功能只在accepted状态显示，且只有订单相关人员（发布者和接单者）可见

**Q: 如何撤回取消请求？**  
A: 目前不支持撤回，只能等待发布者处理。如需撤回，请通过聊天告知发布者拒绝请求

## 📞 技术支持

- 查看详细文档：[CANCEL-REQUEST-FEATURE.md](CANCEL-REQUEST-FEATURE.md)
- 查看测试报告：[功能实现完成-最终报告.md](功能实现完成-最终报告.md)
- 运行测试：`node test-cancel-request.js`

---

**功能状态**：✅ 已上线，可正常使用
