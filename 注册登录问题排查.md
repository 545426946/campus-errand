# 注册登录问题排查指南

## 问题描述
注册完成后无法登录，返回 401 错误。

## 可能的原因

### 1. 密码验证失败
- 注册时密码加密
- 登录时密码验证失败

### 2. 用户查找失败
- 用户名不匹配
- 数据库查询问题

### 3. 响应拦截器问题
- 401 错误被拦截器处理
- 错误信息不明确

---

## 排查步骤

### 步骤1: 检查后端日志

启动后端服务并查看控制台输出：

```bash
cd errand-back
npm start
```

注册和登录时会输出详细日志：
- 创建用户信息
- 查找用户结果
- 密码验证结果

### 步骤2: 运行测试脚本

```bash
cd errand-back
node test-simple-auth.js
```

这个脚本会：
1. 注册一个新用户
2. 立即使用相同账号密码登录
3. 显示详细的请求和响应信息

### 步骤3: 检查数据库

```sql
-- 查看最新注册的用户
SELECT id, username, email, role, 
       LENGTH(password) as password_length,
       created_at 
FROM users 
ORDER BY created_at DESC 
LIMIT 5;

-- 检查密码字段
SELECT id, username, 
       SUBSTRING(password, 1, 20) as password_prefix
FROM users 
WHERE username = 'your_test_username';
```

### 步骤4: 手动测试密码验证

创建测试脚本 `test-password.js`：

```javascript
const bcrypt = require('bcryptjs');

async function testPassword() {
  const password = '123456';
  
  // 加密
  const hashed = await bcrypt.hash(password, 12);
  console.log('原始密码:', password);
  console.log('加密后:', hashed);
  
  // 验证
  const isValid = await bcrypt.compare(password, hashed);
  console.log('验证结果:', isValid);
}

testPassword();
```

---

## 已做的修复

### 1. 优化响应拦截器

**修改前：**
```javascript
} else if (statusCode === 401) {
  // 直接清除登录信息
  wx.removeStorageSync('token')
  wx.removeStorageSync('userInfo')
  return Promise.reject(new Error('未授权'))
}
```

**修改后：**
```javascript
} else if (statusCode === 401) {
  const message = data.message || '认证失败'
  
  // 只有在已登录状态下收到 401 才清除登录信息
  const token = wx.getStorageSync('token')
  if (token) {
    wx.removeStorageSync('token')
    wx.removeStorageSync('userInfo')
  }
  
  toast.error(message)
  return Promise.reject(new Error(message))
}
```

### 2. 添加详细日志

在 `auth.controller.js` 中添加了详细的日志输出：
- 用户查找结果
- 密码验证结果
- 错误原因

---

## 测试方法

### 方法1: 使用测试脚本

```bash
cd errand-back
node test-simple-auth.js
```

### 方法2: 使用小程序

1. 打开小程序登录页面
2. 切换到注册模式
3. 输入用户名和密码
4. 点击注册
5. 注册成功后，使用相同账号密码登录

### 方法3: 使用 API 测试工具

**注册：**
```
POST http://localhost:3000/api/auth/register
Content-Type: application/json

{
  "username": "testuser123",
  "password": "123456",
  "confirmPassword": "123456"
}
```

**登录：**
```
POST http://localhost:3000/api/auth/login
Content-Type: application/json

{
  "username": "testuser123",
  "password": "123456"
}
```

---

## 常见问题

### Q1: 注册成功但登录失败
**可能原因：**
- 密码加密问题
- 用户名大小写问题
- 数据库字段问题

**解决方法：**
1. 检查后端日志
2. 查看数据库中的用户记录
3. 运行测试脚本验证

### Q2: 返回 401 错误
**可能原因：**
- 用户名或密码错误
- 用户不存在
- 密码验证失败

**解决方法：**
1. 查看后端日志中的详细错误信息
2. 确认用户名和密码正确
3. 检查数据库中是否有该用户

### Q3: 密码验证总是失败
**可能原因：**
- bcrypt 版本问题
- 密码字段长度不够
- 加密轮数不匹配

**解决方法：**
1. 确认 bcrypt 版本：`npm list bcryptjs`
2. 检查数据库 password 字段长度（应该是 VARCHAR(255)）
3. 确认加密轮数一致（都是 12）

---

## 调试技巧

### 1. 查看完整的错误信息

在小程序中：
```javascript
catch (error) {
  console.error('完整错误:', error);
  console.error('错误消息:', error.message);
  console.error('错误堆栈:', error.stack);
}
```

### 2. 查看网络请求

在微信开发者工具中：
1. 打开"调试器"
2. 切换到"Network"标签
3. 查看请求和响应的详细信息

### 3. 查看后端日志

后端会输出详细的日志：
```
创建用户: { username: 'testuser', email: null, role: 'student' }
用户创建成功: { id: 10, username: 'testuser', email: null, role: 'student' }
通过用户名查找用户: testuser 结果: 找到
密码验证结果: true
```

---

## 下一步

如果问题仍然存在，请：

1. **运行测试脚本**
   ```bash
   cd errand-back
   node test-simple-auth.js
   ```

2. **查看后端日志**
   - 注册时的日志
   - 登录时的日志
   - 密码验证结果

3. **检查数据库**
   ```sql
   SELECT * FROM users ORDER BY created_at DESC LIMIT 1;
   ```

4. **提供以下信息**
   - 后端日志输出
   - 测试脚本结果
   - 数据库查询结果
   - 前端错误信息

这样我们就能快速定位问题所在！
