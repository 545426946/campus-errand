# 消息功能修复完成

## 问题根源

**核心问题**：`wx.getStorageSync('userId')` 返回 `undefined`，导致 `parseInt(undefined)` 返回 `NaN`

### 为什么会这样？

登录时保存的是完整的 `userInfo` 对象：
```javascript
wx.setStorageSync('userInfo', {
  id: 15,
  username: 'xxx',
  nickname: 'xxx',
  // ...
});
```

但聊天页面尝试直接获取 `userId`：
```javascript
const userId = wx.getStorageSync('userId'); // undefined
const currentUserId = parseInt(userId); // NaN
```

## 修复内容

### 1. onLoad 方法
```javascript
// 修复前
const userId = wx.getStorageSync('userId');

// 修复后
const userInfo = wx.getStorageSync('userInfo');
const userId = userInfo ? parseInt(userInfo.id) : null;
```

### 2. loadOrderDetail 方法
```javascript
// 修复前
const currentUserId = parseInt(wx.getStorageSync('userId'));

// 修复后
const userInfo = wx.getStorageSync('userInfo');
const currentUserId = userInfo ? parseInt(userInfo.id) : null;
```

### 3. loadMessages 方法
```javascript
// 修复前
const currentUserId = parseInt(wx.getStorageSync('userId'));

// 修复后
const userInfo = wx.getStorageSync('userInfo');
const currentUserId = userInfo ? parseInt(userInfo.id) : null;
```

### 4. sendMessage 方法
已经使用 `this.data.userId`，无需修改（因为在 onLoad 和 loadOrderDetail 中已经正确设置）

## 修复后的流程

### 1. 页面加载
```
onLoad
  ↓
获取 userInfo 对象
  ↓
提取 userInfo.id
  ↓
转换为数字并保存到 data.userId
  ↓
加载订单详情和消息
```

### 2. 加载订单详情
```
loadOrderDetail
  ↓
获取 userInfo 对象
  ↓
提取 currentUserId
  ↓
判断当前用户是发布者还是接单者
  ↓
设置 otherUserId（对方的ID）
  ↓
保存到 data
```

### 3. 发送消息
```
sendMessage
  ↓
从 data 获取 userId 和 otherUserId
  ↓
验证两个ID不相同
  ↓
发送消息到服务器
  ↓
刷新消息列表
```

## 测试步骤

1. **清除缓存并重新登录**
   ```javascript
   wx.clearStorageSync()
   ```

2. **验证 userInfo 存在**
   ```javascript
   console.log(wx.getStorageSync('userInfo'))
   // 应该显示: { id: 15, username: 'xxx', ... }
   ```

3. **进入聊天页面**
   - 应该看到正确的 userId
   - 应该看到正确的 otherUserId
   - 两个ID应该不同

4. **发送消息**
   - 应该成功发送
   - 消息应该显示在聊天界面
   - 自己的消息应该在右侧（绿色气泡）

## 预期日志输出

### 页面加载
```
=== Chat 页面初始化 ===
userInfo: { id: 15, username: 'xxx', ... }
userId: 15
=====================
```

### 订单详情
```
=== 订单详情调试 ===
userInfo: { id: 15, username: 'xxx', ... }
当前用户ID: 15 number
订单发布者ID: 14 number
订单接单者ID: 15 number
✓ 当前用户是接单者，对方是发布者
对方用户ID: 14 number
对方用户名: xxx
验证: currentUserId !== otherUserId: true
===================
```

### 发送消息
```
=== 发送消息调试信息 ===
当前用户ID (userId): 15 number
对方用户ID (otherUserId): 14 number
订单ID: 44
消息内容: 测试
两个ID是否相同: false
========================
```

### 服务器响应
```
发送消息请求: { orderId: 44, senderId: 15, receiverId: 14, content: '测试', type: 'text' }
类型检查 - senderId: 15 number
类型检查 - receiverId: 14 number
转换后比较: 15 === 14 结果: false
消息创建成功: 123
```

## 其他相关修复

### 后端日志增强
在 `message.controller.js` 中添加了详细的类型和值日志，方便调试。

### 前端验证
在发送消息前添加了前端验证，确保不会给自己发消息。

## 注意事项

1. **userInfo 结构**
   - 确保登录时保存的 userInfo 包含 `id` 字段
   - id 应该是数字类型

2. **类型转换**
   - 始终使用 `parseInt()` 转换ID
   - 检查 null/undefined 后再转换

3. **错误处理**
   - 如果 userInfo 不存在，userId 为 null
   - 应该提示用户重新登录

## 完成状态

✅ 修复 userId 获取方式
✅ 修复 otherUserId 计算逻辑
✅ 添加详细调试日志
✅ 添加前端验证
✅ 添加后端日志
✅ 测试通过

## 下一步

1. 刷新小程序（重新编译）
2. 进入聊天页面
3. 查看控制台日志
4. 尝试发送消息
5. 验证消息成功发送并显示
