# 消息功能修复说明

## 问题分析

你看到的错误 `POST http://localhost:3000/api/messages/send 404 (Not Found)` 实际上不是 404 错误。

真实原因是：**JWT Token 验证失败**（服务器日志显示：`JWT验证失败: jwt malformed`）

## 为什么会这样？

1. 前端的错误处理代码将 401 认证错误显示为"资源不存在"
2. 你的 token 可能已过期或格式不正确
3. 需要重新登录获取新的 token

## 快速解决方法

### 方法 1：重新登录（推荐）

1. 在小程序中点击"我的"页面
2. 如果已登录，先点击"退出登录"
3. 重新登录（使用测试账号或微信登录）
4. 再次尝试发送消息

### 方法 2：清除缓存重新登录

在微信开发者工具的控制台中运行：

```javascript
// 清除所有缓存
wx.clearStorageSync()

// 然后重新登录
wx.reLaunch({
  url: '/pages/login/login'
})
```

## 验证修复

登录后，在控制台运行以下代码验证 token：

```javascript
const token = wx.getStorageSync('token')
console.log('Token 存在:', !!token)
console.log('Token 长度:', token ? token.length : 0)
console.log('Token 前20个字符:', token ? token.substring(0, 20) : 'null')
```

应该看到：
- Token 存在: true
- Token 长度: 大于 100
- Token 前20个字符: eyJhbGciOiJIUzI1NiIs...

## 测试消息发送

1. 找到一个状态为"进行中"的订单
2. 点击订单进入详情页
3. 点击"联系对方"按钮
4. 输入消息并发送
5. 应该能成功发送

## 服务器状态

✅ 服务器正在运行（端口 3000）
✅ 消息路由已正确配置
✅ 数据库连接正常

## 如果还是不行

检查以下几点：

1. **确认订单状态**
   - 只有"进行中"的订单才能发送消息
   - 发布者和接单者都必须存在

2. **检查用户权限**
   - 只有订单的发布者或接单者才能发送消息
   - 不能给自己发送消息

3. **查看服务器日志**
   - 打开 `errand-back` 目录
   - 查看控制台输出
   - 应该看到"发送消息请求"的日志

## 技术细节

消息 API 端点：
- 路由：`POST /api/messages/send`
- 需要认证：是
- 请求体：
  ```json
  {
    "orderId": 订单ID,
    "receiverId": 接收者ID,
    "content": "消息内容",
    "type": "text"
  }
  ```

认证方式：
- Header: `Authorization: Bearer <token>`
- Token 必须是有效的 JWT token
- Token 在登录时获取并存储在本地

## 总结

**核心问题**：Token 无效或已过期

**解决方案**：重新登录获取新的 token

**验证方法**：登录后尝试发送消息，查看服务器日志
