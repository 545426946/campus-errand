# 消息发送问题调试

## 问题描述

错误信息：`不能给自己发送消息`
但用户表示不是同一个账号

## 可能的原因

1. **前端获取 otherUserId 逻辑错误**
   - 可能将发布者ID和接单者ID搞混了
   - 可能类型转换有问题（字符串 vs 数字）

2. **订单数据问题**
   - acceptor_id 可能为 null 或未设置
   - user_id 和 acceptor_id 可能相同（不应该发生）

3. **用户ID获取错误**
   - wx.getStorageSync('userId') 可能返回错误的值
   - Token 中的用户ID和存储的用户ID不一致

## 调试步骤

### 1. 查看前端日志

在微信开发者工具控制台中，应该看到：

```
=== 订单详情调试 ===
当前用户ID: 15 number
订单发布者ID: 14 number
订单接单者ID: 15 number
✓ 当前用户是接单者，对方是发布者
对方用户ID: 14 number
对方用户名: xxx
验证: currentUserId !== otherUserId: true
===================
```

### 2. 查看发送消息日志

```
=== 发送消息调试信息 ===
当前用户ID (userId): 15 number
对方用户ID (otherUserId): 14 number
订单ID: 44
消息内容: 测试消息
两个ID是否相同: false
========================
```

### 3. 查看服务器日志

服务器应该显示：

```
发送消息请求: { orderId: 44, senderId: 15, receiverId: 14, content: '测试消息', type: 'text' }
类型检查 - senderId: 15 number
类型检查 - receiverId: 14 number
转换后比较: 15 === 14 结果: false
```

## 常见问题排查

### Q1: otherUserId 为 null 或 undefined

**原因**：订单没有接单者（acceptor_id 为 null）

**解决**：
- 确保订单状态为"已接单"（accepted）
- 确保订单有接单者

### Q2: otherUserId 和 userId 相同

**原因**：逻辑判断错误，将自己设置为对方

**检查**：
```javascript
// 正确的逻辑
if (parseInt(order.user_id) === currentUserId) {
  // 我是发布者，对方是接单者
  otherUserId = parseInt(order.acceptor_id);
} else if (parseInt(order.acceptor_id) === currentUserId) {
  // 我是接单者，对方是发布者
  otherUserId = parseInt(order.user_id);
}
```

### Q3: 类型不匹配

**原因**：ID 有时是字符串，有时是数字

**解决**：统一使用 `parseInt()` 转换

## 修复内容

### 前端修复（chat.js）

1. **添加详细日志**
   - 显示当前用户ID和对方用户ID
   - 显示类型信息
   - 显示比较结果

2. **改进逻辑判断**
   - 使用 `else if` 而不是 `else`
   - 确保 otherUserId 被正确转换为数字
   - 在 setData 时保存 userId

3. **前端验证**
   - 在发送前验证 userId !== otherUserId
   - 确保所有ID都转换为数字

### 后端修复（message.controller.js）

1. **添加详细日志**
   - 显示 senderId 和 receiverId 的值和类型
   - 显示转换后的比较结果

2. **改进错误信息**
   - 在错误日志中显示具体的ID值

## 测试步骤

1. **清除缓存重新登录**
   ```javascript
   wx.clearStorageSync()
   ```

2. **创建测试订单**
   - 用账号A发布订单
   - 用账号B接单

3. **测试聊天**
   - 账号A点击"联系对方"
   - 查看控制台日志
   - 发送测试消息

4. **验证日志**
   - 前端日志应该显示两个不同的ID
   - 服务器日志应该显示验证通过
   - 消息应该成功发送

## 预期结果

### 正常情况

前端日志：
```
当前用户ID: 15
对方用户ID: 14
两个ID是否相同: false
```

服务器日志：
```
senderId: 15
receiverId: 14
转换后比较: 15 === 14 结果: false
消息创建成功: 123
```

### 异常情况

如果还是报错"不能给自己发送消息"，检查：

1. **订单数据是否正确**
   ```sql
   SELECT id, user_id, acceptor_id, status FROM orders WHERE id = 44;
   ```

2. **用户登录信息是否正确**
   ```javascript
   console.log('Storage userId:', wx.getStorageSync('userId'))
   console.log('Token:', wx.getStorageSync('token'))
   ```

3. **Token 中的用户ID**
   - 解码 JWT token 查看用户ID
   - 确保 token 中的ID和 storage 中的ID一致

## 下一步

运行修复后的代码，查看控制台输出的详细日志，根据日志信息确定问题所在。
