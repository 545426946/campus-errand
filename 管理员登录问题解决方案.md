# 管理员登录 401 错误解决方案

## 问题描述

访问管理员登录接口时返回 401 错误：
```
POST http://localhost:3000/api/admin/login 401 (Unauthorized)
```

## 问题原因

在 `app.js` 中，管理员路由被放在了取消请求路由之后。由于取消请求路由使用了 `app.use('/api', ...)` 这样的通配符路径，并且在路由内部使用了全局认证中间件 `router.use(authenticate)`，导致所有 `/api/*` 路径都被要求认证，包括管理员登录接口。

## 解决方案

### 步骤 1：确认路由顺序已修复

✅ 已完成 - `app.js` 中的管理员路由已移到最前面

### 步骤 2：重启后端服务

**重要：必须重启后端服务才能使路由配置生效！**

1. **停止当前运行的后端服务**
   - 在运行后端的命令行窗口按 `Ctrl + C`

2. **重新启动后端服务**
   ```bash
   cd errand-back
   npm start
   ```

3. **确认服务启动成功**
   看到以下信息表示成功：
   ```
   MySQL 连接成功: localhost
   服务器运行在端口 3000
   ```

### 步骤 3：测试登录

运行测试脚本：
```bash
cd errand-back
node test-admin-login.js
```

如果看到 "✓ 登录成功！"，说明问题已解决。

### 步骤 4：访问管理后台

1. 打开浏览器访问 `errand-admin/index.html`
2. 输入用户名：`admin`
3. 输入密码：`admin123`
4. 点击登录

## 技术细节

### 修改前的路由顺序（有问题）
```javascript
app.use('/api/auth', require('./routes/auth.routes'));
// ... 其他路由
app.use('/api', require('./routes/cancelRequest.routes')); // 这个会拦截所有 /api/*
app.use('/api/admin', require('./routes/admin.routes')); // 被上面的路由拦截了
```

### 修改后的路由顺序（正确）
```javascript
app.use('/api/admin', require('./routes/admin.routes')); // 放在最前面
app.use('/api/auth', require('./routes/auth.routes'));
// ... 其他路由
app.use('/api', require('./routes/cancelRequest.routes')); // 放在最后
```

### 为什么要这样做？

Express 路由是按顺序匹配的：
1. 当请求 `/api/admin/login` 时
2. Express 会从上到下检查每个路由
3. 如果 `/api` 路由在前面，它会先匹配到
4. 由于 `/api` 路由有全局认证中间件，会要求登录
5. 导致管理员登录接口无法访问

通过将 `/api/admin` 路由放在最前面：
1. 请求 `/api/admin/login` 时
2. 先匹配到 `/api/admin` 路由
3. 直接进入管理员路由处理
4. 不会被 `/api` 路由拦截

## 验证修复

### 方法 1：使用测试脚本
```bash
cd errand-back
node test-admin-login.js
```

### 方法 2：使用 curl
```bash
curl -X POST http://localhost:3000/api/admin/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

### 方法 3：使用浏览器
直接在管理后台页面登录

## 预期结果

登录成功后应该返回：
```json
{
  "success": true,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "admin": {
      "id": 1,
      "username": "admin",
      "name": "超级管理员",
      "email": "admin@errand.com",
      "role": "super_admin"
    }
  }
}
```

## 常见问题

### Q1: 重启后还是 401 错误
**A:** 检查是否真的重启了服务，而不是只是刷新了浏览器

### Q2: 提示"用户名或密码错误"
**A:** 这是正常的错误提示，说明路由已经正常工作了，只是密码不对。确认使用：
- 用户名：`admin`
- 密码：`admin123`

### Q3: 提示"管理员不存在"
**A:** 运行初始化脚本：
```bash
cd errand-back
node create-admin-table.js
```

### Q4: 无法连接到服务器
**A:** 确认后端服务正在运行：
```bash
curl http://localhost:3000/health
```

## 总结

✅ 问题已定位：路由顺序导致管理员登录被拦截
✅ 解决方案已实施：调整路由顺序
⚠️ **需要操作：重启后端服务使配置生效**

重启后端服务后，管理员系统就可以正常使用了！
