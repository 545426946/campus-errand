# 聊天头像显示说明

## 当前实现

聊天界面的头像显示是**正确的**：

### 布局规则

1. **对方的消息**（`!item.isMine`）
   - 头像在**左边**
   - 消息气泡在右边
   - 白色气泡

2. **我的消息**（`item.isMine`）
   - 头像在**右边**
   - 消息气泡在左边
   - 绿色气泡

这与微信的布局完全一致！

## WXML 结构

```xml
<!-- 对方的消息 -->
<view class="message-wrapper" wx:if="{{!item.isMine}}">
  <image class="avatar" src="{{item.sender_avatar}}"></image>
  <view class="message-content">
    <!-- 消息内容 -->
  </view>
</view>

<!-- 我的消息 -->
<view class="message-wrapper" wx:if="{{item.isMine}}">
  <view class="message-content">
    <!-- 消息内容 -->
  </view>
  <image class="avatar" src="{{item.sender_avatar}}"></image>
</view>
```

## CSS 布局

```css
/* 对方的消息 - 头像在左 */
.message-item.other .message-wrapper {
  flex-direction: row;  /* 从左到右 */
}

/* 我的消息 - 头像在右 */
.message-item.mine .message-wrapper {
  flex-direction: row-reverse;  /* 从右到左 */
}
```

## 头像来源

头像数据来自后端返回的消息对象：

```javascript
{
  sender_id: 15,
  sender_name: "用户昵称",
  sender_avatar: "http://...",  // 发送者头像
  receiver_id: 14,
  receiver_name: "接收者昵称",
  receiver_avatar: "http://...", // 接收者头像
  content: "消息内容",
  isMine: true  // 前端计算
}
```

### isMine 判断逻辑

```javascript
const currentUserId = userInfo ? parseInt(userInfo.id) : null;
const isMine = parseInt(msg.sender_id) === currentUserId;
```

- 如果发送者ID等于当前用户ID，则 `isMine = true`
- 否则 `isMine = false`

## 可能的问题

### 1. 所有消息都显示在左边

**原因**：`isMine` 始终为 `false`

**排查**：
```javascript
console.log('当前用户ID:', currentUserId);
console.log('发送者ID:', msg.sender_id);
console.log('isMine:', isMine);
```

**解决**：确保 `userInfo.id` 正确获取

### 2. 头像不显示或显示默认头像

**原因**：`sender_avatar` 为空或无效

**排查**：
```javascript
console.log('发送者头像:', msg.sender_avatar);
```

**解决**：
- 检查后端是否返回头像URL
- 检查头像URL是否有效
- 确保用户已设置头像

### 3. 头像显示在错误的位置

**原因**：CSS 样式问题

**排查**：
- 检查 `.message-item.mine` 和 `.message-item.other` 类是否正确应用
- 检查 `flex-direction` 是否正确

## 测试步骤

### 1. 验证布局

在微信开发者工具中：

1. 打开聊天页面
2. 发送一条消息
3. 检查：
   - ✅ 我的消息应该在右边，头像在右边
   - ✅ 对方的消息应该在左边，头像在左边

### 2. 验证头像

1. 检查控制台日志：
   ```
   消息1: {
     发送者ID: 15,
     当前用户ID: 15,
     isMine: true,
     发送者头像: "http://..."
   }
   ```

2. 验证：
   - ✅ `isMine` 应该正确判断
   - ✅ 头像URL应该存在

### 3. 验证样式

在开发者工具中检查元素：

1. 选择一条"我的消息"
2. 检查类名：应该有 `message-item mine`
3. 检查 `flex-direction`：应该是 `row-reverse`

## 视觉效果

### 正确的效果

```
对方的消息：
┌────────────────────────────┐
│ 👤 ┌──────────┐            │
│    │ 你好     │            │
│    └──────────┘            │
│    12:34                   │
└────────────────────────────┘

我的消息：
┌────────────────────────────┐
│            ┌──────────┐ 👤 │
│            │ 你好     │    │
│            └──────────┘    │
│                   12:34    │
└────────────────────────────┘
```

## 调试命令

在微信开发者工具控制台运行：

```javascript
// 检查当前用户信息
console.log('userInfo:', wx.getStorageSync('userInfo'));

// 检查消息数据
const page = getCurrentPages()[getCurrentPages().length - 1];
console.log('messages:', page.data.messages);

// 检查每条消息的 isMine
page.data.messages.forEach((msg, i) => {
  console.log(`消息${i}:`, {
    content: msg.content,
    isMine: msg.isMine,
    sender_id: msg.sender_id
  });
});
```

## 总结

当前的实现是**正确的**：

✅ 我的消息头像在右边
✅ 对方的消息头像在左边
✅ 使用 `flex-direction: row-reverse` 实现
✅ 类似微信的布局

如果看到的效果不对，请：
1. 检查控制台日志中的 `isMine` 值
2. 检查头像URL是否有效
3. 刷新页面重新加载
4. 清除缓存重新登录
