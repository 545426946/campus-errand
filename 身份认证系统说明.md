# 身份认证系统说明

## 功能概述

为校园跑腿小程序添加了完整的身份认证系统，用户需要通过学生证/教职工证认证后才能使用完整功能。

## 系统架构

### 后端实现

#### 1. 数据库表结构

**certifications 表**
- `id`: 认证记录ID
- `user_id`: 用户ID
- `type`: 认证类型（student/teacher/staff）
- `real_name`: 真实姓名
- `id_card`: 身份证号
- `student_id`: 学号/工号
- `school`: 学校名称
- `college`: 学院
- `major`: 专业
- `grade`: 年级
- `department`: 部门（教职工）
- `id_card_front`: 身份证正面照片
- `id_card_back`: 身份证背面照片
- `student_card`: 学生证/工作证照片
- `status`: 审核状态（pending/approved/rejected）
- `reject_reason`: 拒绝原因
- `submitted_at`: 提交时间
- `reviewed_at`: 审核时间
- `reviewer_id`: 审核人ID

**users 表新增字段**
- `is_certified`: 是否已认证
- `certification_type`: 认证类型
- `certification_id`: 认证记录ID

#### 2. 模型层 (Certification.js)

主要方法：
- `create()`: 创建认证申请
- `findByUserId()`: 查找用户的认证记录
- `findById()`: 根据ID查找认证
- `getPendingList()`: 获取待审核列表
- `review()`: 审核认证
- `isUserCertified()`: 检查用户是否已认证
- `getStats()`: 获取认证统计

#### 3. 控制器层 (certification.controller.js)

接口功能：
- `submitCertification`: 提交认证申请
- `getCertificationStatus`: 获取认证状态
- `getCertificationDetail`: 获取认证详情
- `getCertificationHistory`: 获取认证历史
- `getPendingCertifications`: 获取待审核列表（管理员）
- `reviewCertification`: 审核认证（管理员）
- `getCertificationStats`: 获取认证统计（管理员）

#### 4. 路由配置 (certification.routes.js)

```
POST   /api/certification/submit          提交认证
GET    /api/certification/status          获取状态
GET    /api/certification/detail          获取详情
GET    /api/certification/history         获取历史
GET    /api/certification/pending         待审核列表
POST   /api/certification/:id/review      审核认证
GET    /api/certification/stats           认证统计
```

### 前端实现

#### 1. API 层 (api/certification.js)

封装了所有认证相关的 API 调用方法。

#### 2. 认证页面 (pages/certification/)

**页面状态：**
- 未认证（none）：显示认证表单
- 审核中（pending）：显示审核状态
- 已通过（approved）：显示认证信息
- 已拒绝（rejected）：显示拒绝原因，可重新申请

**表单字段：**

基本信息：
- 认证类型（学生/教师/职工）
- 真实姓名
- 身份证号
- 学号/工号
- 学校名称

学生信息：
- 学院
- 专业
- 年级

教职工信息：
- 部门

证件照片：
- 身份证正面
- 身份证背面
- 学生证/工作证

#### 3. 用户中心集成

在用户中心页面添加了"身份认证"入口，显示认证状态徽章。

## 使用流程

### 用户认证流程

1. **进入认证页面**
   - 从用户中心点击"身份认证"

2. **填写认证信息**
   - 选择认证类型（学生/教师/职工）
   - 填写个人信息
   - 上传证件照片

3. **提交审核**
   - 系统验证信息完整性
   - 提交后进入待审核状态

4. **等待审核**
   - 管理员审核认证申请
   - 审核通过后自动更新用户状态

5. **认证完成**
   - 用户可以使用完整功能
   - 个人信息显示认证标识

### 管理员审核流程

1. **查看待审核列表**
   - 访问 `/api/certification/pending`
   - 查看所有待审核的认证申请

2. **审核认证**
   - 查看用户提交的信息和证件照片
   - 决定通过或拒绝
   - 拒绝时需要填写原因

3. **审核结果**
   - 通过：用户自动获得认证状态
   - 拒绝：用户可查看原因并重新申请

## 安全特性

1. **数据验证**
   - 身份证号格式验证
   - 必填字段检查
   - 防止重复提交

2. **隐私保护**
   - 身份证号脱敏显示
   - 证件照片访问控制
   - 敏感信息加密存储

3. **权限控制**
   - 用户只能查看自己的认证信息
   - 管理员才能审核认证
   - 认证通过后才能使用特定功能

## 扩展功能

### 可选增强

1. **自动审核**
   - OCR 识别证件信息
   - 与学校系统对接验证
   - 人脸识别验证

2. **认证等级**
   - 基础认证：仅身份证
   - 完整认证：身份证+学生证
   - 高级认证：额外的信用验证

3. **认证有效期**
   - 设置认证过期时间
   - 定期重新认证
   - 毕业自动失效

4. **认证徽章**
   - 在用户头像显示认证标识
   - 不同认证类型不同徽章
   - 提升用户信任度

## 数据库初始化

运行以下命令创建认证表：

```bash
cd errand-back
node create-certifications-table.js
```

## API 测试

### 提交认证申请

```bash
POST /api/certification/submit
Authorization: Bearer {token}

{
  "type": "student",
  "realName": "张三",
  "idCard": "110101199001011234",
  "studentId": "2023001",
  "school": "XX大学",
  "college": "计算机学院",
  "major": "软件工程",
  "grade": "2023级",
  "idCardFront": "http://...",
  "idCardBack": "http://...",
  "studentCard": "http://..."
}
```

### 获取认证状态

```bash
GET /api/certification/status
Authorization: Bearer {token}
```

### 审核认证（管理员）

```bash
POST /api/certification/{id}/review
Authorization: Bearer {token}

{
  "status": "approved",  // 或 "rejected"
  "rejectReason": "证件照片不清晰"  // 拒绝时必填
}
```

## 注意事项

1. 确保上传功能正常工作
2. 配置图片存储路径
3. 设置管理员权限
4. 定期清理过期认证
5. 备份认证数据

## 后续优化

1. 添加认证进度通知
2. 支持批量审核
3. 导出认证报表
4. 认证数据统计分析
5. 移动端优化体验
